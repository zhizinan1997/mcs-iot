**🚀 元芯传感 MCS-IoT 工业级气体监测系统·全景执行手册**

项目代号：MCS-IoT (Metachip Cloud Sense)  
文档性质：商业立项书 & 研发白皮书  
核心理念：极低成本、极致稳定、商业闭环

## ---

**1\. 总体战略与架构综述 (Executive Strategy)**

### **1.1 项目核心商业逻辑**

我们要打造的不仅仅是一个“采集数据的软件”，而是一套\*\*“可复制、防破解、低运维成本”\*\*的工业SaaS资产。

1. **硬件层**：做“哑终端”。仪表只负责采集原始信号，不内置复杂算法。这使得硬件成本降至最低，且算法升级无需召回设备。  
2. **传输层**：做“精算师”。利用 4G 流量策略，在满足客户监控需求（10秒/次）与极端省钱（200MB流量包）之间找到平衡点。  
3. **平台层**：做“大脑”。所有浓度换算、报警逻辑、授权校验都在云端完成，牢牢掌握核心技术与定价权。  
4. **交付层**：做“集装箱”。基于 Docker 技术，无论客户用什么服务器，我们都能一键部署，交付时间从几天缩短到几分钟。

### **1.2 系统架构拓扑 (Docker Compose 编排)**

系统由 6 个核心容器组成，运行在阿里云 2核 2G 服务器上：

* 🟢 **Container 1: Mosquitto** (消息网关) —— 系统的“耳朵”。  
* 🔵 **Container 2: IoT-Worker** (Python核心) —— 系统的“大脑”。  
* 🟡 **Container 3: PostgreSQL+TimescaleDB** (热数据) —— 系统的“短期记忆”。  
* 🟣 **Container 4: Archiver** (Python归档) —— 系统的“搬运工”。  
* 🟠 **Container 5: Admin-Web** (Nginx+FastAPI) —— 系统的“控制台”。  
* ⚪ **Container 6: Data-Viewer** (Streamlit) —— 系统的“分析师”。

## ---

**2\. 感知层：硬件与通讯协议规范 (Perception Layer)**

### **2.1 通讯连接策略**

* **【规范】**：设备连接地址必须配置为 **域名** (mqtt.metachip-iot.com)，严禁写入 IP 地址。端口使用 8883 (SSL/TLS 加密)。  
* **【商业价值】**：**抗风险能力**。云服务器可能会遭受攻击需要更换 IP，或者阿里云涨价我们需要迁移到腾讯云。使用域名，我们只需在后台修改 DNS 解析，全球所有设备自动连入新服务器，无需召回返厂，避免了巨大的售后灾难。  
* **【技术实现】**：  
  * 设备端固件使用 mbedtls 库加载 Let's Encrypt CA 根证书。  
  * 设置心跳包 (Keep-Alive) 为 60 秒，维持 NAT 映射，防止运营商切断连接。

### **2.2 流量控制与数据频率**

* **【痛点】**：4G 模组自带的 5 年流量包仅 200MB/月。若 1秒/次 上传，月消耗 500MB+，导致大规模欠费停机。  
* **【策略】**：  
  * **默认模式 (Default)**：**10 秒**上传一次。月流量 \< 60MB (安全)。  
  * **调试模式 (Debug)**：**1 秒**上传一次。仅在需要精细分析时，由管理员远程开启。  
* **【技术实现】**：  
  * 设备端订阅 metachip/gas/{sn}/cmd 主题。  
  * 服务端下发 JSON 指令：{"cmd": "set\_rate", "interval": 1, "duration": 600}。  
  * 设备收到后，切换为 1秒/次，启动一个 600秒 的倒计时。倒计时结束，自动切回 10秒/次。**这不仅省流量，还防止管理员忘记关闭调试模式。**

### **2.3 数据上报协议 (JSON Payload)**

* **【规范】**：上传**原始物理量**，而非计算后的浓度。  
* **【数据包定义】**：  
  JSON  
  {  
    "ts": 1734321000,       // Unix时间戳 (秒)  
    "seq": 1024,            // 包序号 (0-65535循环)，用于后端统计丢包率  
    "v\_raw": 2350.5,        // \[核心\] 传感器输出的电压(mV)或电阻值  
    "temp": 25.4,           // 环境温度 (用于补偿算法)  
    "humi": 45.0,           // 湿度  
    "bat": 88,              // 电池电量 (0-100%)  
    "rssi": \-75,            // 信号强度 (低于-100dBm视为网络差)  
    "net": "4G",            // 网络类型: 4G/WIFI/LORA  
    "err": 0                // 故障码 (0:正常, 1:传感器断路, 2:预热中)  
  }

* **【商业价值】**：保留 v\_raw 原始数据意味着我们可以在服务器端随意调整计算公式。哪怕传感器老化了，我们远程修改一下参数 k 和 b 就能校准，大大延长设备使用寿命。

## ---

**3\. 核心层：Python Worker 业务逻辑 (Core Business Logic)**

这是系统最核心的后台进程 (iot-worker)，不提供界面，默默干活。

### **3.1 浓度解算引擎 (模块化算法)**

* **【逻辑】**：  
  1. 从 Redis 缓存或 DB 中加载设备 {SN} 的参数：k (斜率), b (截距), t\_coef (温补系数)。  
  2. 应用公式：  
     $$\\text{Concentration} \= k \\times v\_{raw} \+ b \+ t\_{coef} \\times (temp \- 25)$$  
  3. 如果计算结果 \< 0 (因传感器漂移)，强制归零，避免用户困惑。  
* **【管理价值】**：实现了“软硬解耦”。硬件只是采集器，算法智慧在云端。

### **3.2 商业授权锁死系统 (License Guard)**

* **【目标】**：防止客户购买一套 Docker 镜像后，私自拷贝给其他工厂使用。  
* **【技术实现】**：  
  1. **硬件指纹**：Docker 启动时挂载宿主机文件 /etc/machine-id (Linux 唯一标识)。  
  2. **每日点名**：每天凌晨 03:00，Worker 携带 (MachineID \+ LicenseKey) 向元芯官方验证服务器发起 HTTPS 请求。  
  3. **宽限期 (Grace Period)**：  
     * 若验证成功：更新本地 token.json，有效期延至 24 小时后。  
     * 若因断网验证失败：检查 token.json，如果在 **72小时** (3天) 内验证过，允许系统继续运行（黄灯状态）。  
     * **锁死触发**：若超过 72 小时未连接云端，Worker 停止解析 MQTT 数据，API 接口全部返回 403 License Expired，并在大屏弹窗提示。

### **3.3 智能报警分发中心 (Smart Alarm)**

* **【痛点】**：传感器在阈值附近波动（如 99-100-99），会导致客户一分钟收到 10 条短信，造成骚扰和投诉。  
* **【技术实现：防抖机制】**：  
  1. 检测到 Value \> Threshold。  
  2. 查询 Redis 键 last\_alarm\_{sn}\_{type}。  
  3. **判断**：如果 (当前时间 \- 上次报警时间) \< 10分钟，则**仅记录数据库日志，不发送通知**。  
  4. **发送**：如果超过 10 分钟，则调用配置好的渠道发送，并更新 Redis 时间戳。

## ---

**4\. 存储层：冷热分离与归档策略 (Storage & Archiving)**

针对 2H2G 服务器仅 40G 硬盘的现状，我们设计了精密的存储方案。

### **4.1 数据库选型 (PostgreSQL \+ TimescaleDB)**

* **【配置】**：开启 TimescaleDB 扩展，创建“超表 (Hypertable)”。  
* **【压缩策略】**：开启 Chunk Compression。将 24 小时前的数据自动压缩，压缩率可达 90% 以上。  
* **【商业价值】**：在不增加硬件成本的前提下，让低配服务器也能承载数亿条数据。

### **4.2 自动化归档流程 (R2 Archiver)**

* **【策略】**：数据库**只保留最近 3 天**的数据（热数据），用于大屏秒开展示。3 天前的数据视为“冷数据”。  
* **【执行脚本】** (每天凌晨 02:00 运行)：  
  1. **Extract**: 执行 SQL SELECT \* FROM sensor\_data WHERE time \< NOW() \- INTERVAL '3 days'。  
  2. **Transform**: 将数据转换为 CSV 格式，并使用 Gzip 强力压缩。  
     * 文件名：archive\_{sn}\_{date}.csv.gz。  
  3. **Load**: 使用 boto3 库（S3 协议）将文件上传至 **Cloudflare R2** 对象存储。  
     * *注：R2 前 10GB 存储免费，且无出口流量费，比阿里云 OSS 更省钱。*  
  4. **Clean**: 上传成功并校验 MD5 后，执行 SQL DELETE 清理本地数据库空间。  
* **【管理价值】**：实现了“无限存储”。虽然本地只存3天，但历史数据永远在云端备份，随时可取，且成本几乎为零。

## ---

**5\. 应用层：Admin 管理后台详情 (Admin Panel)**

这是管理员的操作界面，要求**极度细致的可配置性**。

### **5.1 报警渠道配置 (Notification Settings)**

在“系统设置” \-\> “报警配置”页签下，设计三个独立的卡片：

* **✉️ 邮件通知 (SMTP)**  
  * **开关**：\[ON/OFF\]  
  * **服务器**：输入框 (如 smtp.aliyun.com)  
  * **端口**：输入框 (如 465\)  
  * **账号/密码**：加密存储  
  * **收件人**：支持输入多个邮箱，用分号隔开。  
* **🤖 机器人通知 (Webhook)**  
  * **开关**：\[ON/OFF\]  
  * **类型**：下拉菜单 (钉钉 / 飞书 / 企业微信 / 自定义)  
  * **Webhook URL**：输入框 (即机器人的钩子地址)  
  * **Secret Key**：输入框 (用于加签验权)  
  * **消息模板**：支持变量替换，如 设备 {sn} 在 {time} 发生 {type} 报警，浓度 {val}。  
* **📱 短信通知 (SMS)**  
  * **开关**：\[ON/OFF\]  
  * **服务商**：默认阿里云  
  * **AccessKey ID / Secret**：输入框  
  * **签名名称**：输入框 (如 元芯传感)  
  * **模板代码**：输入框 (如 SMS\_12345678)

### **5.2 设备管理与大屏配置**

* **公式配置**：每个设备详情页都有 K 值和 B 值输入框，修改后立即生效，无需重启设备。  
* **调试模式**：每个设备有一个红色按钮“开启 1秒/次 调试”，点击后倒计时 10 分钟。  
* **大屏拖拽**：  
  1. 上传一张 JPG 格式的工厂平面图。  
  2. 界面加载该图。  
  3. 列表列出所有设备图标。  
  4. 鼠标拖拽图标到地图上的任意位置。  
  5. 点击“保存”，系统计算并存储每个图标相对于背景图的 Left% 和 Top% 坐标。

## ---

**6\. 用户端：可视化大屏与离线分析 (Frontend)**

### **6.1 实时大屏 (Dashboard)**

* **【技术核心】**：**WebSocket**。  
  * 前端建立长连接 wss://mqtt.metachip-iot.com/ws。  
  * 后端 Worker 每收到一条 MQTT 数据，处理完后直接推送到 WebSocket。  
  * **【优势】**：相比 HTTP 轮询（每秒问服务器一次），WebSocket 是服务器主动推数据，延迟极低，且不消耗服务器查询性能。  
* **【交互】**：  
  * **背景**：加载 Admin 上传的平面图。  
  * **点位**：根据 Left%/Top% 渲染小圆点。  
  * **动画**：设备报警时，图标周围出现 CSS3 红色波纹扩散动画。  
  * **详情**：点击图标，右侧滑出侧边栏，通过 API 调取 TimescaleDB 中最近 1 小时的分钟级聚合数据，绘制 ECharts 曲线。

### **6.2 离线分析器 (Archive Viewer)**

* **【定义】**：这是一个独立的 Docker 容器，基于 Streamlit 构建。  
* **【使用流程】**：  
  1. 管理员从 R2 存储桶下载去年的归档文件 2024\_data.csv.gz。  
  2. 打开 Viewer 网页 (如 http://localhost:8501)。  
  3. 拖入文件。  
  4. 系统自动解压、清洗，并生成可交互的“历史趋势图”、“报警分布热力图”、“传感器健康度报告”。  
* **【商业价值】**：将此作为高级功能出售，或者作为解决客户“数据丢失焦虑”的定心丸。

## ---

**7\. 成本概算与资源边界 (Cost & Limits)**

### **7.1 年度运营成本表 (按 100 台设备规模)**

| 费用项 | 规格/说明 | 预估单价 | 年度总价 | 备注 |
| :---- | :---- | :---- | :---- | :---- |
| **云服务器** | 阿里云 ECS 2核2G 5M带宽 (经济型) | ¥79.00/年 | ¥79.00 | 利用 TimescaleDB 压缩技术，配置足够 |
| **域名** | .com 或 .cn | ¥60.00/年 | ¥60.00 | 必须项，用于绑定 SSL 和 动态 IP |
| **对象存储** | Cloudflare R2 | $0 (10GB内免费) | ¥0.00 | 归档数据存储，无需阿里云 OSS 流量费 |
| **4G 流量** | 物联网卡 (含5年流量) | ¥32.00/张 | (硬件成本) | **必须严格执行 10秒/次 策略** |
| **短信包** | 阿里云 SMS | ¥0.045/条 | ¥50.00 | 按需充值，预估 1000 条报警 |
| **SSL 证书** | Let's Encrypt | 免费 | ¥0.00 | 自动脚本续期 |
| **总计** |  |  | **¥189.00** | **极低运营成本** |

### **7.2 性能与硬件瓶颈**

1. **并发连接**：Mosquitto 支持 2000+ 连接无压力。但受限于 Python 处理逻辑，建议单台服务器**不超过 500 台**设备同时在线。  
2. **带宽占用**：  
   * 100 台 x 10秒/次 \= 每秒 10 个包 \= 5KB/s。  
   * 5Mbps 带宽 \= 640KB/s。占用率 \< 1%。**非常安全**。  
3. **大屏电脑要求**：由于地图渲染和 ECharts 动画在浏览器端运行，建议客户使用配有独立显卡或较新核显的电脑，推荐使用 Chrome 浏览器。**不支持 IE**。

## ---

**8\. 实施路线图 (Implementation Roadmap)**

1. **Phase 1: 基础设施 (Day 1-3)**  
   * 购买域名、服务器。  
   * 编写 docker-compose.yml，跑通 Mosquitto 和 PGSQL。  
2. **Phase 2: 核心联调 (Day 4-10)**  
   * **硬件**：调试固件，确保能连接域名并发送 JSON。  
   * **软件**：编写 Worker，实现数据入库、Redis 缓存公式、浓度计算。  
3. **Phase 3: 管理闭环 (Day 11-20)**  
   * 开发 Admin 界面：实现报警渠道的独立配置（SMTP/Webhook）。  
   * 开发 License 校验：实现硬件绑定 \+ 72小时宽限期逻辑。  
4. **Phase 4: 视觉呈现 (Day 21-25)**  
   * 开发 WebSocket 服务。  
   * 完成大屏的地图拖拽功能。  
5. **Phase 5: 归档与交付 (Day 26-30)**  
   * 编写 R2 自动归档脚本。  
   * 进行 100 客户端并发压测 (模拟)。  
   * 交付 Docker 镜像与说明书。
