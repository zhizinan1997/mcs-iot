# 元芯传感 MCS-IoT 工业级气体监测系统 - 项目实施计划

## 项目概述

本项目是一套**低成本、高并发、商业保护**的工业物联网气体监测平台，目标客户为中小型化工厂，设备规模 10-500 台。

> [!IMPORTANT]
> 项目核心理念：**极低成本、极致稳定、商业闭环**

---

## 系统架构总览

```
┌──────────────────────────────────────────────────────────────┐
│                          五层架构                             │
├──────────────────────────────────────────────────────────────┤
│  应用层   │ Admin后台 (Vue+FastAPI) │ 可视化大屏 │ 离线分析工具 │
│  计算层   │ Python Worker (核心处理引擎)                      │
│  存储层   │ TimescaleDB (热数据) │ Redis (缓存) │ R2 (冷存储)  │
│  传输层   │ Eclipse Mosquitto (MQTT 5.0 + TLS)               │
│  感知层   │ 气体探测器硬件 (ESP32/STM32 + 4G模组)             │
└──────────────────────────────────────────────────────────────┘
```

**Docker 容器组成**：

- 🟢 **nginx** - Web网关 (:443/:80)
- 🔵 **backend** - FastAPI后端 (:8000)
- 🟣 **worker** - 核心处理进程 (无端口)
- 🟡 **timescaledb** - 时序数据库 (:5432)
- ⚪ **redis** - 缓存 (:6379)
- 🟠 **mosquitto** - MQTT Broker (:8883)

---

## 📋 项目实施阶段划分 (30天周期)

### Phase 1: 本地基础设施搭建 (Day 1-3)

| 任务 | 具体内容 | 交付物 |
|------|----------|--------|
| **1.1 环境初始化** | 本地创建项目目录、生成自签名 SSL 证书 | 目录结构、证书文件 |
| **1.2 Docker 环境** | 编写 `docker-compose.yml`，配置 6 个容器 (Local Mode) | 容器可正常启动 |
| **1.3 Mosquitto 配置** | TLS 加密 (自签名)、ACL 访问控制、密码文件 | MQTT 8883端口可连接 |
| **1.4 数据库初始化** | PostgreSQL + TimescaleDB 超表、索引、压缩策略 | 表结构创建完成 |

> [!NOTE]
> 开发阶段在本地电脑 (Localhost) 进行，服务器和域名购买推迟到 Phase 5 上线前进行。

---

### Phase 2: 核心联调 (Day 4-10)

#### 2.1 硬件固件开发

| 任务 | 具体内容 | 交付物 |
|------|----------|--------|
| 固件状态机 | 上电→初始化→4G连接→正常运行→断网模式 | 固件可编译运行 |
| MQTT 客户端 | 连接域名、TLS 加密、心跳维持 | 能连接服务端 |
| 数据上报协议 | JSON 格式：`ts, seq, v_raw, temp, humi, bat, rssi, err` | 10秒/次上报 |
| 下行命令处理 | 调试模式切换、校准参数更新、OTA升级 | 命令可响应 |
| 离线缓存 | 断网时本地存储1000条，恢复后续传 | 断网续传正常 |

#### 2.2 Python Worker 核心模块

| 模块 | 功能 | 关键代码 |
|------|------|----------|
| `mqtt_client.py` | MQTT连接管理、消息收发、断线重连 | paho-mqtt |
| `processor.py` | 消息分发器，路由到各处理模块 | 异步处理 |
| `calibrator.py` | **浓度解算引擎** - 公式：`ppm = k × v_raw + b + t_comp × (temp - 25)` | 核心算法 |
| `storage.py` | 数据库写入、批量插入、事务管理 | asyncpg |
| `cache.py` | Redis 缓存操作、设备状态管理 | aioredis |

**浓度解算公式**：

```
Concentration = k × v_raw + b + t_comp × (temp - t_ref)
```

- 参数从 Redis/DB 读取，远程可调
- 结果 < 0 时强制归零
- 结果 > 50000 时标记异常

---

### Phase 3: 管理闭环 (Day 11-20)

#### 3.1 报警中心 (`alarm.py`)

| 功能 | 实现细节 |
|------|----------|
| 阈值判断 | `ppm > high_limit` 或 `ppm < low_limit` |
| **防抖机制** | Redis 键 `alarm:last:{sn}:{type}`，10分钟内不重复发送 |
| 时段过滤 | 非工作时间仅记录日志，不发送通知 |
| 多渠道通知 | 邮件(SMTP) + Webhook(钉钉/飞书) + 短信(阿里云SMS) |

#### 3.2 授权守卫 (`license.py`)

| 机制 | 说明 |
|------|------|
| 硬件绑定 | 读取宿主机 `/etc/machine-id`，防止镜像复制 |
| 每日校验 | 凌晨3点向授权服务器发送验证请求 |
| 宽限期 | 断网72小时内可运行（黄灯状态），超时锁死 |
| 锁死行为 | Worker停止解析数据，API返回403，页面弹窗提示 |

#### 3.3 Admin 管理后台 (FastAPI + Vue)

| 模块 | 功能 |
|------|------|
| 设备管理 | 列表、添加、编辑、校准参数(k/b值)、报警阈值 |
| 报警配置 | 邮件渠道、Webhook渠道、短信渠道独立配置卡片 |
| 大屏配置 | 上传工厂平面图、拖拽设备到位置、保存坐标(x%/y%) |
| 系统设置 | R2存储配置、授权信息查看、操作审计日志 |

---

### Phase 4: 视觉呈现 (Day 21-25)

#### 4.1 WebSocket 实时推送

```javascript
// 大屏 WebSocket 数据流
ws://server/ws/dashboard

// 服务端推送格式
{"type": "realtime", "data": [{"sn":"A001","ppm":50,"status":"online"}]}
{"type": "alarm", "data": {"sn":"A015","ppm":1200,"type":"HIGH"}}
```

#### 4.2 可视化大屏

| 区域 | 功能 |
|------|------|
| 顶部状态栏 | 在线/离线/报警设备统计、实时时间 |
| 工厂平面图 | 背景图上叠加设备图标，颜色表示状态 |
| 报警滚动列表 | 最新报警记录，红色高亮 |
| 趋势图 | 点击设备显示最近1小时 ECharts 曲线 |
| 动画效果 | 报警设备周围 CSS3 红色波纹扩散 |

---

### Phase 5: 归档与交付 (Day 26-30)

#### 5.1 冷热分离归档 (`archiver.py`)

| 步骤 | 操作 | 时间 |
|------|------|------|
| Extract | 查询3天前的数据 | 凌晨02:00 |
| Transform | 导出为 CSV.GZ 压缩文件 | - |
| Load | 上传至 Cloudflare R2 (S3协议) | boto3 |
| Clean | 删除本地过期数据，释放空间 | 确认上传成功后 |

**文件命名**: `archive/2025/12/sensor_data_20251213.csv.gz`

#### 5.2 离线分析工具 (Streamlit)

- 独立 Docker 容器
- 上传 CSV.GZ 归档文件
- 自动生成历史趋势图、报警热力图、传感器健康度报告

#### 5.3 交付与压测

| 任务 | 内容 |
|------|------|
| 并发压测 | 模拟100台设备同时在线 |
| 文档交付 | API文档、部署手册、操作指南 |
| Docker镜像 | 打包发布，一键部署脚本 |

---

## 🔧 技术栈选型

| 层级 | 组件 | 技术选型 | 选型理由 |
|------|------|----------|----------|
| 感知层 | 主控 | ESP32-S3 / STM32L4 | 低功耗、4G兼容 |
| 感知层 | 通信 | 移远EC200S | 成熟稳定 |
| 传输层 | 协议 | MQTT 5.0 + TLS 1.3 | 低带宽、高可靠 |
| 传输层 | Broker | Eclipse Mosquitto 2.x | 轻量、ACL支持 |
| 计算层 | 语言 | Python 3.11 | 开发效率高 |
| 计算层 | 框架 | FastAPI | 异步高性能 |
| 存储层 | 时序库 | PostgreSQL 15 + TimescaleDB | 压缩率高 |
| 存储层 | 缓存 | Redis 7.x | 报警防抖、会话 |
| 存储层 | 对象存储 | Cloudflare R2 | 免费额度 |
| 应用层 | 前端 | Vue 3 + Element Plus | 组件丰富 |
| 应用层 | 图表 | ECharts 5.x | 大屏可视化 |

---

## 💰 成本概算 (100台设备/年)

| 费用项 | 规格 | 预估年费 |
|--------|------|----------|
| 云服务器 | 阿里云 2核2G 5M | ¥79 |
| 域名 | .com | ¥60 |
| SSL证书 | Let's Encrypt | ¥0 |
| 对象存储 | Cloudflare R2 10GB内 | ¥0 |
| 短信包 | 阿里云SMS ~1000条 | ¥50 |
| **总计** | | **¥189/年** |

> [!TIP]
> 对比传统方案 (¥50,000+/年)，节省 **97%** 以上。

---

## 📁 项目目录结构

```
mcs-iot/
├── docker-compose.yml        # 容器编排
├── .env.example             # 环境变量模板
├── install.sh               # 一键安装脚本
├── nginx/                   # Nginx配置
├── mosquitto/               # MQTT配置
│   ├── mosquitto.conf
│   ├── passwd               # 认证文件
│   └── acl                  # ACL规则
├── worker/                  # Python Worker
│   ├── Dockerfile
│   ├── requirements.txt
│   └── src/
│       ├── main.py          # 入口
│       ├── mqtt_client.py   # MQTT连接
│       ├── processor.py     # 消息分发
│       ├── calibrator.py    # 浓度解算
│       ├── alarm.py         # 报警中心
│       ├── storage.py       # DB写入
│       ├── archiver.py      # 数据归档
│       ├── license.py       # 授权守卫
│       └── scheduler.py     # 定时任务
├── backend/                 # FastAPI 后端
│   ├── Dockerfile
│   └── src/
├── frontend/                # Vue 前端
│   └── dist/
└── scripts/                 # 运维脚本
    ├── backup.sh
    └── update.sh
```

---

## ✅ 实施检查清单

### Phase 1 (Day 1-3)

- [ ] 域名购买与DNS解析
- [ ] 阿里云ECS服务器购买
- [ ] Docker + Docker Compose 安装
- [ ] docker-compose.yml 编写完成
- [ ] Mosquitto TLS 配置
- [ ] PostgreSQL + TimescaleDB 初始化

### Phase 2 (Day 4-10)

- [ ] 固件 MQTT 连接调试
- [ ] 数据上报协议实现
- [ ] Worker mqtt_client.py 完成
- [ ] Worker calibrator.py 浓度解算
- [ ] Worker storage.py 数据入库
- [ ] Redis 缓存策略实现

### Phase 3 (Day 11-20)

- [ ] alarm.py 报警中心 + 防抖
- [ ] 邮件通知渠道
- [ ] Webhook 通知渠道 (钉钉/飞书)
- [ ] license.py 授权守卫
- [ ] Admin 设备管理页面
- [ ] Admin 报警配置页面
- [ ] Admin 大屏配置页面

### Phase 4 (Day 21-25)

- [ ] WebSocket 服务端实现
- [ ] 大屏前端开发
- [ ] 工厂平面图拖拽功能
- [ ] ECharts 趋势图
- [ ] 报警动画效果

### Phase 5 (Day 26-30)

- [ ] archiver.py 归档脚本
- [ ] Cloudflare R2 集成
- [ ] Streamlit 离线分析工具
- [ ] 100台设备并发压测
- [ ] 部署文档与交付

---

## 🚀 下一步行动

请告诉我你想从哪个阶段开始，我会带着你一步一步完成。建议按以下顺序：

1. **Phase 1 - 基础设施** → 先把服务器和Docker环境搭建好
2. **Phase 2 - 核心联调** → 实现Worker核心逻辑，验证数据流通
3. **Phase 3 - 管理闭环** → 报警、授权、Admin后台
4. **Phase 4 - 视觉呈现** → 大屏和WebSocket
5. **Phase 5 - 归档交付** → 归档和压测

你想从**哪个阶段**开始？或者有特定的模块想先实现？
