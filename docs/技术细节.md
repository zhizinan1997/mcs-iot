# 元芯传感 MCS-IoT 工业级气体监测系统
## 深度技术执行手册 v2.0
作者：Ryan Zhi携手Gemini & Claude老师
---

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **项目代号** | MCS-IoT (Metachip Cloud Sensing - IoT) |
| **版本** | v2.0 Final |
| **适用对象** | 项目经理、软硬件工程师、运维人员 |
| **核心定位** | 低成本、高并发、商业保护的工业物联网气体监测平台 |

---

## 目录

1. [系统总览与架构设计](#1-系统总览与架构设计)
2. [感知层：硬件与通信协议](#2-感知层硬件与通信协议)
3. [传输层：MQTT Broker 配置](#3-传输层mqtt-broker-配置)
4. [计算层：Python Worker 核心逻辑](#4-计算层python-worker-核心逻辑)
5. [存储层：数据库与冷热分离](#5-存储层数据库与冷热分离)
6. [应用层：管理后台与可视化大屏](#6-应用层管理后台与可视化大屏)
7. [安全层：授权与防护机制](#7-安全层授权与防护机制)
8. [运维层：部署与监控](#8-运维层部署与监控)
9. [成本与性能评估](#9-成本与性能评估)
10. [附录：接口规范与配置模板](#10-附录接口规范与配置模板)

---

## 1. 系统总览与架构设计

### 1.1 系统定位图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          MCS-IoT 系统定位                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────┐         ┌─────────────┐         ┌─────────────┐         │
│    │  传统方案    │         │  MCS-IoT    │         │  高端方案   │         │
│    ├─────────────┤         ├─────────────┤         ├─────────────┤         │
│    │ 成本: ¥5万+ │         │ 成本: ¥200  │         │ 成本: ¥50万+│         │
│    │ 容量: 50台  │         │ 容量: 500台 │         │ 容量: 万台  │         │
│    │ 部署: 复杂  │         │ 部署: 一键  │         │ 部署: 定制  │         │
│    │ 维护: 专业  │         │ 维护: 自动  │         │ 维护: 团队  │         │
│    └─────────────┘         └──────┬──────┘         └─────────────┘         │
│                                   │                                         │
│                                   ▼                                         │
│                    ┌──────────────────────────────┐                        │
│                    │  目标客户：中小型化工厂      │                        │
│                    │  设备规模：10-500台          │                        │
│                    │  核心诉求：便宜、稳定、合规  │                        │
│                    └──────────────────────────────┘                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 五层架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MCS-IoT 五层架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        应用层 (Application)                        │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │    │
│  │  │ Admin 后台   │  │ 可视化大屏   │  │ 离线分析工具 (Streamlit) │ │    │
│  │  │ Vue.js+Nginx │  │ Vue+ECharts  │  │ Python + Pandas          │ │    │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    ▲                                        │
│                                    │ REST API / WebSocket                   │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        计算层 (Processing)                         │    │
│  │  ┌──────────────────────────────────────────────────────────────┐ │    │
│  │  │                    Python Worker (核心)                       │ │    │
│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐│ │    │
│  │  │  │浓度解算器  │ │报警中心    │ │授权守卫    │ │归档管理器  ││ │    │
│  │  │  │Calibrator │ │AlarmCenter │ │LicenseGuard│ │Archiver    ││ │    │
│  │  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘│ │    │
│  │  └──────────────────────────────────────────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    ▲                                        │
│                                    │ SQL / Redis                            │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        存储层 (Storage)                            │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │    │
│  │  │ TimescaleDB  │  │   Redis      │  │  Cloudflare R2 (冷存储)  │ │    │
│  │  │ 热数据(3天)  │  │ 缓存+会话    │  │  归档数据 (永久)         │ │    │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    ▲                                        │
│                                    │ MQTT 5.0 + TLS                         │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        传输层 (Transport)                          │    │
│  │  ┌──────────────────────────────────────────────────────────────┐ │    │
│  │  │                    Eclipse Mosquitto                          │ │    │
│  │  │           端口: 8883 (MQTTS) | ACL 访问控制                   │ │    │
│  │  └──────────────────────────────────────────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                    ▲                                        │
│                                    │ 4G/NB-IoT                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        感知层 (Perception)                         │    │
│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐      │    │
│  │  │ 设备1  │  │ 设备2  │  │ 设备3  │  │  ...   │  │ 设备N  │      │    │
│  │  │ SN:A01 │  │ SN:A02 │  │ SN:A03 │  │        │  │ SN:Axx │      │    │
│  │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘      │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Docker 容器编排图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Docker Compose 容器编排                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    宿主机 (阿里云 2核2G ECS)                                                │
│    ┌─────────────────────────────────────────────────────────────────────┐ │
│    │                        Docker Network: mcs-net                       │ │
│    │  ┌─────────────────────────────────────────────────────────────────┐│ │
│    │  │                                                                  ││ │
│    │  │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       ││ │
│    │  │   │   nginx     │────▶│  backend    │     │   worker    │       ││ │
│    │  │   │  :443/:80   │     │  :8000      │     │  (无端口)   │       ││ │
│    │  │   │  Gateway    │     │  FastAPI    │     │  Python     │       ││ │
│    │  │   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘       ││ │
│    │  │          │                   │                   │              ││ │
│    │  │          │                   ▼                   ▼              ││ │
│    │  │          │            ┌─────────────┐     ┌─────────────┐       ││ │
│    │  │          │            │   redis     │◀───▶│ timescaledb │       ││ │
│    │  │          │            │   :6379     │     │   :5432     │       ││ │
│    │  │          │            │   缓存层    │     │   持久层    │       ││ │
│    │  │          │            └─────────────┘     └─────────────┘       ││ │
│    │  │          │                                                      ││ │
│    │  │          ▼                                                      ││ │
│    │  │   ┌─────────────┐                                               ││ │
│    │  │   │  mosquitto  │◀───── 设备 MQTT 连接                          ││ │
│    │  │   │   :8883     │                                               ││ │
│    │  │   │  MQTT Broker│                                               ││ │
│    │  │   └─────────────┘                                               ││ │
│    │  │                                                                  ││ │
│    │  └─────────────────────────────────────────────────────────────────┘│ │
│    │                                                                     │ │
│    │  数据卷挂载:                                                        │ │
│    │  ./data/postgres  → /var/lib/postgresql/data                       │ │
│    │  ./data/redis     → /data                                          │ │
│    │  ./certs          → /etc/mosquitto/certs                           │ │
│    │  /etc/machine-id  → /app/host_id (只读, 授权绑定)                  │ │
│    └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.4 技术栈选型表

| 层级 | 组件 | 技术选型 | 选型理由 |
|------|------|----------|----------|
| 感知层 | 主控芯片 | ESP32-S3 / STM32L4 | 低功耗、4G模组兼容 |
| 感知层 | 通信模组 | 移远EC20/EC200S | 成熟稳定、驱动完善 |
| 传输层 | 协议 | MQTT 5.0 + TLS 1.3 | 低带宽、高可靠 |
| 传输层 | Broker | Eclipse Mosquitto 2.x | 轻量、ACL支持 |
| 计算层 | 语言 | Python 3.11 | 开发效率、生态丰富 |
| 计算层 | 框架 | FastAPI | 异步高性能、自动文档 |
| 存储层 | 时序库 | PostgreSQL 15 + TimescaleDB | 压缩率高、SQL兼容 |
| 存储层 | 缓存 | Redis 7.x | 报警防抖、会话管理 |
| 存储层 | 对象存储 | Cloudflare R2 | 免费额度、S3兼容 |
| 应用层 | 前端 | Vue 3 + Element Plus | 组件丰富、生态成熟 |
| 应用层 | 图表 | ECharts 5.x | 大屏可视化专用 |
| 运维层 | 容器 | Docker + Compose | 一键部署、环境隔离 |

---

## 2. 感知层：硬件与通信协议

### 2.1 硬件系统框图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          气体探测器硬件架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   电源管理                  主控单元                    通信单元             │
│   ┌────────────────┐       ┌─────────────────┐        ┌────────────────┐   │
│   │  电池/DC输入   │       │                 │        │                │   │
│   │  ┌──────────┐ │       │   ESP32-S3      │        │   4G模组       │   │
│   │  │ 充电管理 │ │       │   ┌───────────┐ │        │   EC200S       │   │
│   │  │ TP4056   │ │       │   │ Dual Core │ │  UART  │   ┌──────────┐ │   │
│   │  └────┬─────┘ │       │   │ 240MHz    │─┼────────┼──▶│ AT指令   │ │   │
│   │       │       │       │   └───────────┘ │        │   │ MQTT客户端│ │   │
│   │  ┌────▼─────┐ │  3.3V │   ┌───────────┐ │        │   └──────────┘ │   │
│   │  │  LDO     │─┼───────┼──▶│   PSRAM   │ │        │        │       │   │
│   │  │ AMS1117  │ │       │   │   4MB     │ │        │   ┌────▼─────┐ │   │
│   │  └──────────┘ │       │   └───────────┘ │        │   │  SIM卡   │ │   │
│   └────────────────┘       └────────┬────────┘        │   │ IoT专用  │ │   │
│                                     │                 │   └──────────┘ │   │
│   传感器阵列                        │ SPI/I2C         └────────────────┘   │
│   ┌────────────────────────────────┼───────────────────────────────────┐   │
│   │                                │                                    │   │
│   │  ┌──────────┐  ┌──────────┐   │   ┌──────────┐  ┌──────────┐      │   │
│   │  │ 气体传感器│  │ 温湿度   │   │   │  ADC     │  │  状态LED │      │   │
│   │  │ MQ-4/MiCS│  │ SHT30    │◀──┴──▶│ 16bit    │  │  RGB     │      │   │
│   │  │ 模拟输出 │  │ I2C      │       │ ADS1115  │  │  WS2812  │      │   │
│   │  └──────────┘  └──────────┘       └──────────┘  └──────────┘      │   │
│   │                                                                    │   │
│   └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   本地存储 & 看门狗                                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐│   │
│   │  │  EEPROM  │  │   RTC    │  │  WDT     │  │     Flash存储        ││   │
│   │  │ 24C32    │  │ DS3231   │  │ 内置     │  │ 离线缓存 (1000条)    ││   │
│   │  │ 4KB      │  │ 备份时钟 │  │ 30s超时  │  │ 断网续传             ││   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────────────────┘│   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 固件状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          固件主状态机                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────┐                                    │
│                              │  上电   │                                    │
│                              └────┬────┘                                    │
│                                   │                                         │
│                                   ▼                                         │
│                           ┌──────────────┐                                  │
│                           │   初始化     │                                  │
│                           │ - 读取配置   │                                  │
│                           │ - 自检传感器 │                                  │
│                           │ - 初始化4G   │                                  │
│                           └──────┬───────┘                                  │
│                                  │                                          │
│                    ┌─────────────┼─────────────┐                           │
│                    │             │             │                            │
│                    ▼             ▼             ▼                            │
│             ┌──────────┐  ┌──────────┐  ┌──────────┐                       │
│             │ 自检失败 │  │ 4G连接中 │  │ 自检通过 │                       │
│             │ 红灯闪烁 │  │ 黄灯常亮 │  │          │                       │
│             └──────────┘  └────┬─────┘  └────┬─────┘                       │
│                                │             │                              │
│                                ▼             ▼                              │
│        ┌──────────────────────────────────────────────────────┐            │
│        │                                                      │            │
│        │              ┌─────────────────────┐                 │            │
│        │              │     正常运行        │◀────────────────┤            │
│        │              │   ┌─────────────┐   │                 │            │
│        │              │   │ 采集循环    │   │     超时重连    │            │
│        │              │   │ 10s/次(默认)│   │                 │            │
│        │              │   │ 1s/次(调试) │   │  ┌──────────┐  │            │
│        │              │   └──────┬──────┘   │  │ 断网模式 │  │            │
│        │              │          │          │  │ - 本地缓存│  │            │
│        │              │          ▼          │  │ - 续传队列│  │            │
│        │              │   ┌─────────────┐   │  └─────┬────┘  │            │
│        │              │   │ MQTT发送    │───┼────────┘       │            │
│        │              │   └─────────────┘   │                 │            │
│        │              └─────────────────────┘                 │            │
│        │                        │                             │            │
│        │                        ▼                             │            │
│        │              ┌─────────────────────┐                 │            │
│        │              │   接收下行命令      │                 │            │
│        │              │   Topic: .../cmd    │                 │            │
│        │              └─────────┬───────────┘                 │            │
│        │                        │                             │            │
│        │           ┌────────────┼────────────┐                │            │
│        │           ▼            ▼            ▼                │            │
│        │    ┌──────────┐ ┌──────────┐ ┌──────────┐           │            │
│        │    │调试模式  │ │校准命令  │ │重启命令  │           │            │
│        │    │切换频率  │ │更新参数  │ │远程重启  │           │            │
│        │    └──────────┘ └──────────┘ └──────────┘           │            │
│        │                                                      │            │
│        └──────────────────────────────────────────────────────┘            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 MQTT 数据协议

#### 上行数据 (设备 → 服务器)

**Topic**: `mcs/{sn}/up`

```json
{
  "ts": 1734320000,       // Unix时间戳 (秒)
  "seq": 1024,            // 包序号 (0-65535循环)
  "v_raw": 2350.5,        // 原始电压 (mV) - 服务器换算PPM
  "temp": 25.4,           // 温度 (℃) - 用于温度补偿
  "humi": 65.2,           // 湿度 (%) - 可选
  "bat": 85,              // 电量 (%)
  "rssi": -75,            // 信号强度 (dBm)
  "net": "4G",            // 网络类型
  "ver": "1.0.2",         // 固件版本
  "err": 0                // 错误码 (0=正常, 1=传感器异常, 2=低电...)
}
```

#### 下行命令 (服务器 → 设备)

**Topic**: `mcs/{sn}/cmd`

```json
// 切换调试模式 (1秒/次, 持续600秒后自动恢复)
{"cmd": "debug", "duration": 600}

// 校准参数更新
{"cmd": "calib", "k": 1.5, "b": -10, "t_comp": 0.1}

// 远程重启
{"cmd": "reboot", "delay": 5}

// OTA升级
{"cmd": "ota", "url": "https://fw.metachip.com/v1.0.3.bin", "md5": "abc123..."}
```

### 2.4 流量优化策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          流量控制策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   默认模式 (省流量)                     调试模式 (高频率)                    │
│   ┌─────────────────────────┐          ┌─────────────────────────┐         │
│   │  上报频率: 10秒/次      │          │  上报频率: 1秒/次       │         │
│   │  单包大小: ~150字节     │          │  单包大小: ~150字节     │         │
│   │  日流量: ~1.3 MB        │          │  日流量: ~13 MB         │         │
│   │  月流量: ~40 MB         │          │  (仅临时, 最长10分钟)   │         │
│   │  IoT卡: 绰绰有余        │          │  触发条件: 收到debug命令│         │
│   └─────────────────────────┘          └─────────────────────────┘         │
│                                                                             │
│   流量计算公式:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  每条消息 ≈ 150 Bytes (JSON) + 50 Bytes (MQTT头+TLS) = 200 Bytes    │   │
│   │  默认模式: 200B × 6次/分 × 60分 × 24时 = 17.28 MB/天 (含心跳)      │   │
│   │  安全余量: 5年卡 1GB/年 → 每月 83MB → 日均 2.7MB → 实际1.3MB 安全  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 传输层：MQTT Broker 配置 (续)

### 3.1 Mosquitto 架构图 (续)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Mosquitto Broker 架构 (续)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   │  ┌────────────────────────────────────────────────────────────────┐  │ │
│   │  │                        ACL 访问控制                             │  │ │
│   │  │                                                                 │  │ │
│   │  │  设备用户 (device_{sn}):                                        │  │ │
│   │  │    ├─ 可发布: mcs/{sn}/up        (上报数据)                     │  │ │
│   │  │    └─ 可订阅: mcs/{sn}/cmd       (接收命令)                     │  │ │
│   │  │                                                                 │  │ │
│   │  │  Worker用户 (worker):                                           │  │ │
│   │  │    ├─ 可订阅: mcs/+/up           (接收所有设备数据)             │  │ │
│   │  │    └─ 可发布: mcs/+/cmd          (下发命令给任意设备)           │  │ │
│   │  │                                                                 │  │ │
│   │  │  Admin用户 (admin):                                             │  │ │
│   │  │    └─ 可订阅/发布: mcs/#         (完全权限, 调试用)             │  │ │
│   │  │                                                                 │  │ │
│   │  └────────────────────────────────────────────────────────────────┘  │ │
│   │                                                                       │ │
│   │  ┌────────────────────────────────────────────────────────────────┐  │ │
│   │  │                        认证模块                                 │  │ │
│   │  │                                                                 │  │ │
│   │  │    ┌─────────────┐         ┌─────────────────────────┐         │  │ │
│   │  │    │ 密码文件    │   OR    │  动态认证插件 (可选)    │         │  │ │
│   │  │    │ passwd_file │         │  mosquitto-auth-plug    │         │  │ │
│   │  │    │ (静态)      │         │  (查询Redis/DB)         │         │  │ │
│   │  │    └─────────────┘         └─────────────────────────┘         │  │ │
│   │  │                                                                 │  │ │
│   │  └────────────────────────────────────────────────────────────────┘  │ │
│   │                                                                       │ │
│   └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 核心配置文件

**mosquitto.conf 核心配置：**

```conf
# 外部监听 (设备接入)
listener 8883
certfile /certs/server.crt
keyfile /certs/server.key
require_certificate false

# 内部监听 (Worker)
listener 1883 127.0.0.1

# 认证与ACL
password_file /mosquitto/config/passwd
acl_file /mosquitto/config/acl
```

**ACL 规则示例：**

```conf
user worker
topic readwrite mcs/#

pattern write mcs/%u/up
pattern read mcs/%u/cmd
```

### 3.3 连接流程时序图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        设备连接与数据上报时序                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   设备(SN:A001)          Mosquitto             Worker              数据库   │
│        │                     │                    │                   │     │
│        │  1. TLS握手         │                    │                   │     │
│        │────────────────────▶│                    │                   │     │
│        │◀────────────────────│                    │                   │     │
│        │                     │                    │                   │     │
│        │  2. CONNECT         │                    │                   │     │
│        │  user:device_A001   │                    │                   │     │
│        │  pass:xxxx          │                    │                   │     │
│        │────────────────────▶│                    │                   │     │
│        │                     │                    │                   │     │
│        │                     │  验证密码+ACL      │                   │     │
│        │                     │─────────┐          │                   │     │
│        │                     │◀────────┘          │                   │     │
│        │                     │                    │                   │     │
│        │  3. CONNACK(OK)     │                    │                   │     │
│        │◀────────────────────│                    │                   │     │
│        │                     │                    │                   │     │
│        │  4. SUBSCRIBE       │                    │                   │     │
│        │  mcs/A001/cmd       │                    │                   │     │
│        │────────────────────▶│                    │                   │     │
│        │                     │                    │                   │     │
│        │  5. SUBACK          │                    │                   │     │
│        │◀────────────────────│                    │                   │     │
│        │                     │                    │                   │     │
│   ─────┼─────────────────────┼────────────────────┼───────────────────┼─────│
│   循环 │                     │                    │                   │     │
│        │  6. PUBLISH         │                    │                   │     │
│        │  mcs/A001/up        │                    │                   │     │
│        │  {v_raw:2350...}    │                    │                   │     │
│        │────────────────────▶│                    │                   │     │
│        │                     │                    │                   │     │
│        │                     │  7. 转发消息       │                   │     │
│        │                     │───────────────────▶│                   │     │
│        │                     │                    │                   │     │
│        │                     │                    │  8. 解算PPM       │     │
│        │                     │                    │  9. 检查报警      │     │
│        │                     │                    │  10. 写入DB       │     │
│        │                     │                    │──────────────────▶│     │
│        │                     │                    │                   │     │
│        │                     │                    │  11. INSERT OK    │     │
│        │                     │                    │◀──────────────────│     │
│        │                     │                    │                   │     │
│   ─────┼─────────────────────┼────────────────────┼───────────────────┼─────│
│        │                     │                    │                   │     │
│        │  12. PINGREQ (60s)  │                    │                   │     │
│        │────────────────────▶│                    │                   │     │
│        │  13. PINGRESP       │                    │                   │     │
│        │◀────────────────────│                    │                   │     │
│        │                     │                    │                   │     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 计算层：Python Worker 核心逻辑

### 4.1 Worker 模块架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Python Worker 模块架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         main.py (入口)                               │   │
│   │   - 初始化日志                                                       │   │
│   │   - 加载配置                                                         │   │
│   │   - 启动各模块                                                       │   │
│   │   - 注册信号处理 (优雅退出)                                          │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│           ┌───────────────────────┼───────────────────────┐                │
│           │                       │                       │                 │
│           ▼                       ▼                       ▼                 │
│   ┌───────────────┐     ┌─────────────────┐     ┌─────────────────┐        │
│   │ license.py    │     │ mqtt_client.py  │     │ scheduler.py    │        │
│   │ ┌───────────┐ │     │ ┌─────────────┐ │     │ ┌─────────────┐ │        │
│   │ │授权校验   │ │     │ │MQTT连接管理 │ │     │ │定时任务     │ │        │
│   │ │机器码绑定 │ │     │ │消息收发     │ │     │ │- 日归档     │ │        │
│   │ │宽限期管理 │ │     │ │断线重连     │ │     │ │- 日校验     │ │        │
│   │ └───────────┘ │     │ └─────────────┘ │     │ │- 健康检查   │ │        │
│   └───────┬───────┘     └────────┬────────┘     └───────┬───────┘          │
│           │                      │                      │                   │
│           │         ┌────────────┴────────────┐         │                   │
│           │         ▼                         │         │                   │
│           │   ┌─────────────────┐             │         │                   │
│           │   │ processor.py   │             │         │                   │
│           │   │ ┌─────────────┐│             │         │                   │
│           │   │ │消息分发器   ││◀────────────┘         │                   │
│           │   │ │路由到各处理 ││                       │                   │
│           │   │ └──────┬──────┘│                       │                   │
│           │   └────────┼───────┘                       │                   │
│           │            │                               │                   │
│   ┌───────┴────────────┼───────────────────────────────┴─────────────┐     │
│   │                    │                                              │     │
│   ▼                    ▼                               ▼              ▼     │
│ ┌──────────┐    ┌──────────────┐    ┌──────────────┐  ┌──────────────┐     │
│ │calibrator│    │ alarm.py     │    │ storage.py   │  │ archiver.py  │     │
│ │  .py     │    │ ┌──────────┐ │    │ ┌──────────┐ │  │ ┌──────────┐ │     │
│ │┌────────┐│    │ │报警判断  │ │    │ │DB写入    │ │  │ │数据归档  │ │     │
│ ││浓度解算││───▶│ │阈值比对  │ │───▶│ │批量插入  │ │  │ │CSV导出   │ │     │
│ ││温度补偿││    │ │防抖控制  │ │    │ │事务管理  │ │  │ │R2上传    │ │     │
│ ││公式计算││    │ └──────────┘ │    │ └──────────┘ │  │ │过期清理  │ │     │
│ │└────────┘│    │ ┌──────────┐ │    └──────────────┘  │ └──────────┘ │     │
│ └──────────┘    │ │多渠道通知│ │                      └──────────────┘     │
│                 │ │- 邮件    │ │                                           │
│                 │ │- Webhook │ │                                           │
│                 │ │- 短信    │ │                                           │
│                 │ └──────────┘ │                                           │
│                 └──────────────┘                                           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         共享模块                                     │   │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│   │  │ db.py      │  │ cache.py   │  │ config.py  │  │ logger.py  │    │   │
│   │  │ PostgreSQL │  │ Redis连接  │  │ 配置加载   │  │ 日志管理   │    │   │
│   │  │ 连接池     │  │ 缓存操作   │  │ 环境变量   │  │ 格式化     │    │   │
│   │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 浓度解算流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          浓度解算流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入: {"sn": "A001", "v_raw": 2350.5, "temp": 28.5}                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 1: 获取设备校准参数 (优先Redis缓存, 否则查DB)                  │   │
│   │                                                                      │   │
│   │    params = {                                                        │   │
│   │      "k": 1.5,           # 斜率                                      │   │
│   │      "b": -10,           # 截距                                      │   │
│   │      "t_ref": 25,        # 参考温度                                  │   │
│   │      "t_comp": 0.1,      # 温度补偿系数                              │   │
│   │      "unit": "ppm"       # 输出单位                                  │   │
│   │    }                                                                 │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 2: 基础线性转换                                                │   │
│   │                                                                      │   │
│   │    base_ppm = k × v_raw + b                                          │   │
│   │            = 1.5 × 2350.5 + (-10)                                    │   │
│   │            = 3515.75 ppm                                             │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 3: 温度补偿                                                    │   │
│   │                                                                      │   │
│   │    temp_offset = t_comp × (temp - t_ref)                             │   │
│   │                = 0.1 × (28.5 - 25)                                   │   │
│   │                = 0.35 ppm                                            │   │
│   │                                                                      │   │
│   │    final_ppm = base_ppm + temp_offset                                │   │
│   │              = 3515.75 + 0.35                                        │   │
│   │              = 3516.1 ppm                                            │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 4: 数据校验与边界处理                                          │   │
│   │                                                                      │   │
│   │    if final_ppm < 0:                                                 │   │
│   │        final_ppm = 0        # 负值修正                               │   │
│   │    if final_ppm > 50000:                                             │   │
│   │        final_ppm = 50000    # 量程上限                               │   │
│   │        set_error_flag()     # 标记异常                               │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   输出: {"sn": "A001", "v_raw": 2350.5, "ppm": 3516.1, "temp": 28.5}        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**核心代码片段：**

```python
def calculate_ppm(sn: str, v_raw: float, temp: float) -> float:
    params = cache.get(f"calib:{sn}") or db.get_calib_params(sn)
    base = params['k'] * v_raw + params['b']
    comp = params['t_comp'] * (temp - params['t_ref'])
    return max(0, min(base + comp, 50000))
```

### 4.3 报警中心流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          报警处理流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入: {"sn": "A001", "ppm": 3516.1, "ts": 1734320000}                     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 1: 获取报警规则                                                │   │
│   │                                                                      │   │
│   │    rules = {                                                         │   │
│   │      "high_limit": 1000,      # 高报阈值                             │   │
│   │      "low_limit": 50,         # 低报阈值 (可选)                      │   │
│   │      "debounce": 600,         # 防抖时间 (秒)                        │   │
│   │      "enable_time": {                                                │   │
│   │        "days": [1,2,3,4,5],   # 周一到周五                           │   │
│   │        "start": "08:00",                                             │   │
│   │        "end": "18:00"                                                │   │
│   │      }                                                               │   │
│   │    }                                                                 │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 2: 阈值判断                                                    │   │
│   │                                                                      │   │
│   │              ppm < low_limit        正常范围        ppm > high_limit │   │
│   │                    │                   │                   │         │   │
│   │                    ▼                   ▼                   ▼         │   │
│   │              ┌─────────┐         ┌─────────┐         ┌─────────┐    │   │
│   │              │ 低报警  │         │ 无报警  │         │ 高报警  │    │   │
│   │              │ type=LOW│         │ RETURN  │         │type=HIGH│    │   │
│   │              └────┬────┘         └─────────┘         └────┬────┘    │   │
│   │                   │                                       │         │   │
│   │                   └───────────────┬───────────────────────┘         │   │
│   │                                   │                                  │   │
│   └───────────────────────────────────┼──────────────────────────────────┘   │
│                                       ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 3: 防抖检查 (Anti-Debounce)                                    │   │
│   │                                                                      │   │
│   │    last_alarm_key = f"alarm:last:{sn}:{type}"                        │   │
│   │    last_time = redis.get(last_alarm_key)                             │   │
│   │                                                                      │   │
│   │    if last_time and (now - last_time) < debounce:                    │   │
│   │        ┌─────────────────────────────────────────────┐               │   │
│   │        │  跳过通知, 仅记录日志                       │               │   │
│   │        │  log.info("防抖: 10分钟内重复报警已抑制")   │               │   │
│   │        │  RETURN                                     │               │   │
│   │        └─────────────────────────────────────────────┘               │   │
│   │    else:                                                             │   │
│   │        redis.set(last_alarm_key, now, ex=debounce)                   │   │
│   │        → 继续下一步                                                  │   │
│   │                                                                      │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 4: 时段检查                                                    │   │
│   │                                                                      │   │
│   │    current_weekday = datetime.now().weekday()  # 0=周一              │   │
│   │    current_time = datetime.now().strftime("%H:%M")                   │   │
│   │                                                                      │   │
│   │    if current_weekday not in rules.enable_time.days:                 │   │
│   │        notification_level = "LOG_ONLY"                               │   │
│   │    elif not (start <= current_time <= end):                          │   │
│   │        notification_level = "LOG_ONLY"                               │   │
│   │    else:                                                             │   │
│   │        notification_level = "FULL"                                   │   │
│   │                                                                      │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 5: 多渠道通知分发                                              │   │
│   │                                                                      │   │
│   │    if notification_level == "FULL":                                  │   │
│   │                                                                      │   │
│   │        ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │   │
│   │        │  邮件通知   │     │  Webhook    │     │  短信通知   │      │   │
│   │        │ ┌─────────┐ │     │ ┌─────────┐ │     │ ┌─────────┐ │      │   │
│   │        │ │检查开关 │ │     │ │检查开关 │ │     │ │检查开关 │ │      │   │
│   │        │ │ON? ─────┼─┼────▶│ │ON? ─────┼─┼────▶│ │ON? ─────│ │      │   │
│   │        │ └────┬────┘ │     │ └────┬────┘ │     │ └────┬────┘ │      │   │
│   │        │      ▼      │     │      ▼      │     │      ▼      │      │   │
│   │        │  SMTP发送   │     │ POST请求   │     │ 阿里云SMS  │      │   │
│   │        │  (异步)     │     │ 钉钉/飞书  │     │ (异步)     │      │   │
│   │        └─────────────┘     └─────────────┘     └─────────────┘      │   │
│   │                                                                      │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Step 6: 报警记录入库                                                │   │
│   │                                                                      │   │
│   │    INSERT INTO alarm_logs (sn, type, value, ts, notified)            │   │
│   │    VALUES ('A001', 'HIGH', 3516.1, now(), true)                      │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.4 报警渠道配置详情 (续)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        报警渠道配置 (Admin界面)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  📧 邮件通知 (SMTP)                                    [ON] / OFF   │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  SMTP服务器:    ┌─────────────────────────────────┐                 │   │
│   │                 │ smtp.qq.com                     │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  端口:          ┌─────────┐  □ SSL   ☑ TLS                         │   │
│   │                 │ 587     │                                         │   │
│   │                 └─────────┘                                         │   │
│   │  发件人邮箱:    ┌─────────────────────────────────┐                 │   │
│   │                 │ alarm@metachip.com              │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  授权码:        ┌─────────────────────────────────┐                 │   │
│   │                 │ ********************************│                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  收件人列表:    ┌─────────────────────────────────────────────────┐ │   │
│   │  (分号分隔)     │ admin@factory.com; safety@factory.com           │ │   │
│   │                 └─────────────────────────────────────────────────┘ │   │
│   │                                              [测试发送] [保存]      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  🔔 Webhook通知 (钉钉/飞书/企微)                       [ON] / OFF   │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  平台类型:      ◉ 钉钉   ○ 飞书   ○ 企业微信   ○ 自定义            │   │
│   │                                                                     │   │
│   │  Webhook地址:   ┌─────────────────────────────────────────────────┐ │   │
│   │                 │ https://oapi.dingtalk.com/robot/send?access_... │ │   │
│   │                 └─────────────────────────────────────────────────┘ │   │
│   │  签名密钥:      ┌─────────────────────────────────┐                 │   │
│   │  (可选)         │ SEC1234567890abcdef...          │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  @指定人手机:   ┌─────────────────────────────────┐                 │   │
│   │  (可选,逗号)    │ 13800138000, 13900139000        │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │                                              [测试发送] [保存]      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  📱 短信通知 (阿里云SMS)                               ON / [OFF]   │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  AccessKey ID:  ┌─────────────────────────────────┐                 │   │
│   │                 │ LTAI5txxxxxxxxxxxxxx            │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  AccessSecret:  ┌─────────────────────────────────┐                 │   │
│   │                 │ ********************************│                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  签名名称:      ┌─────────────────────────────────┐                 │   │
│   │                 │ 元芯传感                         │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  模板CODE:      ┌─────────────────────────────────┐                 │   │
│   │                 │ SMS_123456789                   │                 │   │
│   │                 └─────────────────────────────────┘                 │   │
│   │  接收手机:      ┌─────────────────────────────────────────────────┐ │   │
│   │  (逗号分隔)     │ 13800138000, 13900139000                        │ │   │
│   │                 └─────────────────────────────────────────────────┘ │   │
│   │                                              [测试发送] [保存]      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ⚙️ 通用设置                                                        │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  防抖间隔:      ┌─────┐ 分钟   (同一报警类型的静默周期)             │   │
│   │                 │ 10  │                                             │   │
│   │                 └─────┘                                             │   │
│   │  通知时段:      ☑ 启用时段限制                                      │   │
│   │                 工作日: ☑一 ☑二 ☑三 ☑四 ☑五 □六 □日               │   │
│   │                 时间段: ┌──────┐ 至 ┌──────┐                        │   │
│   │                         │08:00 │    │18:00 │                        │   │
│   │                         └──────┘    └──────┘                        │   │
│   │                 ⚠️ 非工作时段的报警仅记录日志,不发送通知             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Webhook 发送核心代码：**

```python
def send_dingtalk(webhook_url: str, secret: str, message: str):
    timestamp = str(round(time.time() * 1000))
    sign = hmac_sha256(f"{timestamp}\n{secret}")
    requests.post(f"{webhook_url}&timestamp={timestamp}&sign={sign}", 
                  json={"msgtype": "text", "text": {"content": message}})
```

### 4.5 授权守卫机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          商业授权保护机制                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        授权校验流程                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│        Docker启动                                                           │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │ 读取宿主机指纹  │     挂载: -v /etc/machine-id:/app/host_id:ro          │
│   │ machine_id      │                                                       │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐     license.key 文件内容:                             │
│   │ 读取授权文件    │     {                                                 │
│   │ /app/license.key│       "license_key": "MCS-XXXX-XXXX-XXXX",           │
│   └────────┬────────┘       "customer": "XX化工厂",                         │
│            │                "max_devices": 100,                             │
│            ▼                "expire_date": "2026-12-31"                     │
│   ┌─────────────────┐     }                                                 │
│   │ 本地初步校验    │                                                       │
│   │ - 格式正确?     │                                                       │
│   │ - 未过期?       │                                                       │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ├──────── 失败 ──────────────────────────────────┐               │
│            │                                                │               │
│            ▼ 通过                                           ▼               │
│   ┌─────────────────┐                              ┌─────────────────┐      │
│   │ 每日在线校验    │◀─────── 定时任务 03:00 ──────│   系统锁死      │      │
│   │ (凌晨3点执行)   │                              │   - 停止Worker  │      │
│   └────────┬────────┘                              │   - API返回403  │      │
│            │                                        │   - 页面提示    │      │
│            ▼                                        └─────────────────┘      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   POST https://license.metachip.com/api/verify                      │   │
│   │   {                                                                 │   │
│   │     "machine_id": "abc123...",                                      │   │
│   │     "license_key": "MCS-XXXX-XXXX-XXXX",                           │   │
│   │     "version": "1.0.0"                                              │   │
│   │   }                                                                 │   │
│   │                                                                     │   │
│   │   响应:                                                             │   │
│   │   { "valid": true, "token_expire": 1734400000, "message": "OK" }   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│            │                                                                │
│            ├──────── 校验成功 ───────┐                                      │
│            │                         ▼                                      │
│            │                ┌─────────────────┐                            │
│            │                │ 更新本地Token   │                            │
│            │                │ 有效期+24小时   │                            │
│            │                │ 绿灯运行        │                            │
│            │                └─────────────────┘                            │
│            │                                                                │
│            ├──────── 网络失败 ───────┐                                      │
│            │                         ▼                                      │
│            │                ┌─────────────────────────────────────┐        │
│            │                │           宽限期检查                 │        │
│            │                │                                     │        │
│            │                │  本地Token剩余时间 > 0 ?            │        │
│            │                │      │                              │        │
│            │                │      ├─ YES: 黄灯运行 (警告日志)    │        │
│            │                │      │       继续服务,等待下次校验  │        │
│            │                │      │                              │        │
│            │                │      └─ NO: 宽限72小时已耗尽        │        │
│            │                │            → 系统锁死               │        │
│            │                │                                     │        │
│            │                └─────────────────────────────────────┘        │
│            │                                                                │
│            └──────── 校验拒绝 (盗版/过期) ──────────────────────────────────┤
│                                                                     │       │
│                                                                     ▼       │
│                                                            ┌──────────────┐ │
│                                                            │  立即锁死    │ │
│                                                            │  无宽限期    │ │
│                                                            └──────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**核心代码片段：**

```python
def verify_license():
    machine_id = open('/app/host_id').read().strip()
    resp = requests.post(LICENSE_SERVER, json={"machine_id": machine_id, "key": KEY})
    if resp.json().get("valid"):
        save_local_token(expire=time.time() + 86400)  # 24小时有效
    elif local_token_remaining() <= 0:
        shutdown_system()  # 锁死
```

---

## 5. 存储层：数据库与冷热分离

### 5.1 数据库表结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据库 ER 图                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        devices (设备表)                              │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  sn           VARCHAR(32)   PK    设备序列号                        │   │
│   │  name         VARCHAR(64)         设备名称/别名                     │   │
│   │  location     VARCHAR(128)        安装位置描述                      │   │
│   │  pos_x        FLOAT               大屏X坐标 (百分比)                │   │
│   │  pos_y        FLOAT               大屏Y坐标 (百分比)                │   │
│   │  calib_k      FLOAT               校准斜率                          │   │
│   │  calib_b      FLOAT               校准截距                          │   │
│   │  calib_t_ref  FLOAT               参考温度                          │   │
│   │  calib_t_comp FLOAT               温度补偿系数                      │   │
│   │  high_limit   FLOAT               高报警阈值                        │   │
│   │  low_limit    FLOAT               低报警阈值                        │   │
│   │  status       VARCHAR(16)         online/offline/alarm              │   │
│   │  last_seen    TIMESTAMP           最后通信时间                      │   │
│   │  created_at   TIMESTAMP           创建时间                          │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │ 1                                        │
│                                  │                                          │
│                                  │ N                                        │
│   ┌──────────────────────────────▼──────────────────────────────────────┐   │
│   │                  sensor_data (传感器数据表 - 超表)                   │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  time         TIMESTAMPTZ   PK    时间戳 (TimescaleDB分区键)        │   │
│   │  sn           VARCHAR(32)   FK    设备序列号                        │   │
│   │  v_raw        FLOAT               原始电压 (mV)                     │   │
│   │  ppm          FLOAT               解算浓度                          │   │
│   │  temp         FLOAT               温度                              │   │
│   │  humi         FLOAT               湿度                              │   │
│   │  bat          INTEGER             电量百分比                        │   │
│   │  rssi         INTEGER             信号强度                          │   │
│   │  seq          INTEGER             包序号                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      alarm_logs (报警记录表)                         │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  id           SERIAL        PK    自增主键                          │   │
│   │  sn           VARCHAR(32)   FK    设备序列号                        │   │
│   │  alarm_type   VARCHAR(16)         HIGH/LOW/OFFLINE/LOW_BAT          │   │
│   │  value        FLOAT               触发时的数值                      │   │
│   │  threshold    FLOAT               阈值                              │   │
│   │  triggered_at TIMESTAMP           触发时间                          │   │
│   │  notified     BOOLEAN             是否已发送通知                    │   │
│   │  channels     VARCHAR(64)         通知渠道 (email,sms,webhook)      │   │
│   │  ack_at       TIMESTAMP           确认时间 (可选)                   │   │
│   │  ack_by       VARCHAR(32)         确认人 (可选)                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     system_config (系统配置表)                       │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  key          VARCHAR(64)   PK    配置键                            │   │
│   │  value        TEXT                配置值 (JSON格式)                 │   │
│   │  updated_at   TIMESTAMP           更新时间                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   配置键示例:                                                               │
│   - "alarm.email"    → {"enabled":true,"smtp_host":"...","recipients":[]}  │
│   - "alarm.webhook"  → {"enabled":true,"url":"...","secret":"..."}         │
│   - "alarm.sms"      → {"enabled":false,"access_key":"..."}                │
│   - "archive.r2"     → {"endpoint":"...","bucket":"...","access_key":"..."}│
│   - "dashboard.bg"   → {"image_url":"/static/uploads/factory.jpg"}         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 TimescaleDB 配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TimescaleDB 时序优化配置                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 创建超表 (Hypertable)                                            │   │
│   │                                                                      │   │
│   │  -- 将普通表转换为超表,按天自动分片                                  │   │
│   │  SELECT create_hypertable('sensor_data', 'time',                     │   │
│   │         chunk_time_interval => INTERVAL '1 day');                    │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. 启用压缩 (节省90%存储)                                           │   │
│   │                                                                      │   │
│   │  -- 设置压缩选项                                                     │   │
│   │  ALTER TABLE sensor_data SET (                                       │   │
│   │    timescaledb.compress,                                             │   │
│   │    timescaledb.compress_segmentby = 'sn'                             │   │
│   │  );                                                                  │   │
│   │                                                                      │   │
│   │  -- 自动压缩1天前的数据                                              │   │
│   │  SELECT add_compression_policy('sensor_data', INTERVAL '1 day');     │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  3. 创建索引                                                         │   │
│   │                                                                      │   │
│   │  -- 按设备+时间查询优化                                              │   │
│   │  CREATE INDEX idx_sensor_sn_time ON sensor_data (sn, time DESC);     │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   存储效果估算 (100台设备, 10秒/次):                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   原始数据: 100设备 × 8640条/天 × 100字节 ≈ 82 MB/天                 │   │
│   │   压缩后:   82 MB × 10% ≈ 8.2 MB/天                                  │   │
│   │   3天热数据: 8.2 × 3 ≈ 25 MB                                         │   │
│   │                                                                      │   │
│   │   结论: 2G内存服务器完全够用                                         │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 冷热分离归档流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据冷热分离架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│         热数据 (0-3天)                              冷数据 (3天+)            │
│   ┌─────────────────────────┐                ┌─────────────────────────┐   │
│   │                         │                │                         │   │
│   │     TimescaleDB         │   ──归档──▶   │    Cloudflare R2        │   │
│   │     (PostgreSQL)        │                │    (对象存储)           │   │
│   │                         │                │                         │   │
│   │  - 实时查询             │                │  - CSV.GZ 压缩文件      │   │
│   │  - 报警判断             │                │  - 按天归档             │   │
│   │  - 大屏展示             │                │  - 永久保存             │   │
│   │  - API响应              │                │  - 合规审计             │   │
│   │                         │                │                         │   │
│   └─────────────────────────┘                └─────────────────────────┘   │
│              │                                          │                   │
│              │                                          │                   │
│              ▼                                          ▼                   │
│   ┌─────────────────────────┐                ┌─────────────────────────┐   │
│   │  Admin后台 / 大屏       │                │  离线分析工具           │   │
│   │  实时数据 + 3天历史     │                │  下载CSV后本地分析      │   │
│   └─────────────────────────┘                └─────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          归档任务流程 (每日凌晨02:00)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────┐  │
│   │ Step 1  │────▶│ Step 2  │────▶│ Step 3  │────▶│ Step 4  │────▶│Done │  │
│   │ 查询    │     │ 导出    │     │ 上传    │     │ 清理    │     │     │  │
│   └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────┘  │
│                                                                             │
│   Step 1: 查询待归档数据                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  SELECT * FROM sensor_data                                          │   │
│   │  WHERE time < NOW() - INTERVAL '3 days'                             │   │
│   │  AND time >= NOW() - INTERVAL '4 days'                              │   │
│   │  ORDER BY time;                                                     │   │
│   │                                                                      │   │
│   │  -- 每次只处理1天的数据,避免内存溢出                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Step 2: 导出为压缩CSV                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  文件名: sensor_data_20251213.csv.gz                                │   │
│   │  格式:   time,sn,v_raw,ppm,temp,humi,bat,rssi,seq                   │   │
│   │  大小:   约 2-5 MB/天 (100台设备)                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Step 3: 上传至R2                                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  import boto3                                                       │   │
│   │  s3 = boto3.client('s3', endpoint_url=R2_ENDPOINT,                  │   │
│   │                    aws_access_key_id=R2_ACCESS_KEY, ...)            │   │
│   │  s3.upload_file('sensor_data_20251213.csv.gz',                      │   │
│   │                 BUCKET, 'archive/2025/12/sensor_data_20251213.csv.gz')│  │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Step 4: 清理本地数据                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  -- 上传成功后才删除                                                 │   │
│   │  DELETE FROM sensor_data                                            │   │
│   │  WHERE time < NOW() - INTERVAL '3 days';                            │   │
│   │                                                                      │   │
│   │  -- 记录归档日志                                                     │   │
│   │  INSERT INTO archive_logs (date, file_name, size, status)           │   │
│   │  VALUES ('2025-12-13', 'sensor_data_20251213.csv.gz', 2.5, 'OK');   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 冷热分离归档流程 (续)

**归档核心代码片段：**

```python
def archive_old_data():
    target_date = datetime.now() - timedelta(days=3)
    rows = db.query(f"SELECT * FROM sensor_data WHERE time::date = '{target_date}'")
    csv_path = f"/tmp/sensor_data_{target_date}.csv.gz"
    pd.DataFrame(rows).to_csv(csv_path, compression='gzip')
    s3.upload_file(csv_path, BUCKET, f"archive/{target_date.year}/{csv_path}")
    db.execute(f"DELETE FROM sensor_data WHERE time::date = '{target_date}'")
```

### 5.4 Redis 缓存策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Redis 缓存设计                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         缓存键设计                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────┬──────────────────────┬─────────┬──────────────────┐  │
│   │      键名        │        用途          │  TTL    │     示例值        │  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ calib:{sn}      │ 设备校准参数缓存      │ 1小时   │ {"k":1.5,"b":-10}│  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ device:{sn}     │ 设备信息缓存          │ 5分钟   │ {"name":"1号"}   │  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ alarm:last:{sn} │ 最后报警时间(防抖)    │ 10分钟  │ 1734320000       │  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ online:{sn}     │ 设备在线状态          │ 90秒    │ 1 (存在即在线)   │  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ realtime:{sn}   │ 最新一条数据          │ 30秒    │ {"ppm":50,...}   │  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ license:token   │ 授权Token有效期       │ 24小时  │ 1734400000       │  │
│   ├─────────────────┼──────────────────────┼─────────┼──────────────────┤  │
│   │ config:{key}    │ 系统配置缓存          │ 10分钟  │ {"enabled":true} │  │
│   └─────────────────┴──────────────────────┴─────────┴──────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       缓存更新策略                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   读取流程 (Cache-Aside Pattern):                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │     请求数据                                                         │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    ┌─────────┐                                                       │   │
│   │    │ Redis   │──── 命中 ────▶ 返回数据                               │   │
│   │    └────┬────┘                                                       │   │
│   │         │ 未命中                                                     │   │
│   │         ▼                                                            │   │
│   │    ┌─────────┐                                                       │   │
│   │    │ 查询DB  │                                                       │   │
│   │    └────┬────┘                                                       │   │
│   │         │                                                            │   │
│   │         ▼                                                            │   │
│   │    写入Redis (设置TTL) ──────▶ 返回数据                              │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   在线状态判断:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   # 收到数据时刷新                                                   │   │
│   │   redis.setex(f"online:{sn}", 90, 1)   # 90秒过期                   │   │
│   │                                                                      │   │
│   │   # 判断是否在线                                                     │   │
│   │   is_online = redis.exists(f"online:{sn}")                          │   │
│   │                                                                      │   │
│   │   # 原理: 设备每10秒上报,90秒内无数据则Key过期,判定离线              │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 应用层：管理后台与可视化大屏

### 6.1 系统功能模块图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          应用层功能模块                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         管理后台 (Admin)                             │   │
│   │                         /admin/*                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│   │   │   登录认证    │  │   仪表盘      │  │   设备管理    │           │   │
│   │   │               │  │               │  │               │           │   │
│   │   │ • JWT Token   │  │ • 在线统计    │  │ • 设备列表    │           │   │
│   │   │ • 会话管理    │  │ • 报警统计    │  │ • 添加/编辑   │           │   │
│   │   │ • 权限控制    │  │ • 系统状态    │  │ • 校准参数    │           │   │
│   │   │               │  │ • 快捷入口    │  │ • 报警阈值    │           │   │
│   │   └───────────────┘  └───────────────┘  └───────────────┘           │   │
│   │                                                                      │   │
│   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│   │   │   报警配置    │  │   大屏配置    │  │   系统设置    │           │   │
│   │   │               │  │               │  │               │           │   │
│   │   │ • 邮件渠道    │  │ • 背景图上传  │  │ • R2存储配置  │           │   │
│   │   │ • Webhook     │  │ • 设备拖拽    │  │ • 授权信息    │           │   │
│   │   │ • 短信配置    │  │ • 位置保存    │  │ • 系统日志    │           │   │
│   │   │ • 防抖设置    │  │ • 预览效果    │  │ • 数据归档    │           │   │
│   │   └───────────────┘  └───────────────┘  └───────────────┘           │   │
│   │                                                                      │   │
│   │   ┌───────────────┐  ┌───────────────┐                              │   │
│   │   │   报警记录    │  │   数据查询    │                              │   │
│   │   │               │  │               │                              │   │
│   │   │ • 历史列表    │  │ • 设备选择    │                              │   │
│   │   │ • 状态筛选    │  │ • 时间范围    │                              │   │
│   │   │ • 报警确认    │  │ • 数据导出    │                              │   │
│   │   │ • 导出Excel   │  │ • 趋势图表    │                              │   │
│   │   └───────────────┘  └───────────────┘                              │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        可视化大屏 (Dashboard)                        │   │
│   │                        /dashboard                                    │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                     顶部状态栏                               │   │   │
│   │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────────┐  │   │   │
│   │   │  │在线: 95  │ │离线: 3   │ │报警: 2   │ │ 2025-12-17     │  │   │   │
│   │   │  │   台     │ │   台     │ │   台     │ │ 14:30:25       │  │   │   │
│   │   │  └──────────┘ └──────────┘ └──────────┘ └────────────────┘  │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                     工厂平面图区域                           │   │   │
│   │   │                                                             │   │   │
│   │   │      ┌────┐                           ┌────┐                │   │   │
│   │   │      │ 🟢 │ A001                      │ 🔴 │ A015           │   │   │
│   │   │      │ 50 │ 正常                      │1200│ 报警!          │   │   │
│   │   │      └────┘                           └────┘                │   │   │
│   │   │                    ┌────┐                                   │   │   │
│   │   │                    │ 🟢 │ A008                              │   │   │
│   │   │                    │ 35 │ 正常                              │   │   │
│   │   │   ┌────┐          └────┘           ┌────┐                  │   │   │
│   │   │   │ ⚫ │ A003                       │ 🟢 │ A022             │   │   │
│   │   │   │ -- │ 离线                       │ 80 │ 正常             │   │   │
│   │   │   └────┘                            └────┘                  │   │   │
│   │   │                                                             │   │   │
│   │   │   (背景: 工厂平面图.jpg)                                    │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   │   ┌──────────────────────┐  ┌────────────────────────────────────┐  │   │
│   │   │     报警滚动列表     │  │          趋势图 (点击设备显示)     │  │   │
│   │   │                      │  │                                    │  │   │
│   │   │ ⚠ A015 浓度超标      │  │     ▲                              │  │   │
│   │   │   14:28 | 1200 ppm   │  │  ppm│    ╱╲    ╱╲                  │  │   │
│   │   │                      │  │     │   ╱  ╲  ╱  ╲___              │  │   │
│   │   │ ⚠ A003 设备离线      │  │     │__╱    ╲╱                     │  │   │
│   │   │   14:15 | 超时90s    │  │     └──────────────────────▶ 时间  │  │   │
│   │   │                      │  │       最近1小时趋势图              │  │   │
│   │   └──────────────────────┘  └────────────────────────────────────┘  │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 大屏拖拽配置交互流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        大屏配置 - 设备位置编辑                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Admin后台 → 大屏配置                                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   Step 1: 上传背景图                                                 │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  ┌─────────────────────────────────────────────────────┐    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  │     📁 点击上传 或 拖拽图片到此处                   │    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  │     支持 JPG/PNG, 建议尺寸 1920×1080               │    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  └─────────────────────────────────────────────────────┘    │   │   │
│   │   │                                         [上传] [使用默认]   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   │   Step 2: 拖拽设备到对应位置                                         │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                             │   │   │
│   │   │   设备列表 (左侧)              预览区域 (右侧)              │   │   │
│   │   │   ┌─────────────┐              ┌───────────────────────┐   │   │   │
│   │   │   │ □ A001 1号点│   拖拽 ──▶  │   [工厂平面图背景]    │   │   │   │
│   │   │   │ □ A002 2号点│              │                       │   │   │   │
│   │   │   │ □ A003 3号点│              │    ┌───┐              │   │   │   │
│   │   │   │ ☑ A004 4号点│◀── 已放置   │    │A04│ ←可继续拖动  │   │   │   │
│   │   │   │ □ A005 5号点│              │    └───┘              │   │   │   │
│   │   │   │    ...      │              │                       │   │   │   │
│   │   │   └─────────────┘              │         ┌───┐         │   │   │   │
│   │   │                                │         │A01│         │   │   │   │
│   │   │   未放置: 灰色                 │         └───┘         │   │   │   │
│   │   │   已放置: 绿色勾选             │                       │   │   │   │
│   │   │                                └───────────────────────┘   │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   │   Step 3: 保存位置                                                   │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                             │   │   │
│   │   │   点击 [保存配置] 后:                                       │   │   │
│   │   │                                                             │   │   │
│   │   │   POST /api/devices/positions                               │   │   │
│   │   │   {                                                         │   │   │
│   │   │     "A001": {"x": 45.5, "y": 62.3},   // 百分比坐标         │   │   │
│   │   │     "A004": {"x": 20.1, "y": 35.8},                         │   │   │
│   │   │     ...                                                     │   │   │
│   │   │   }                                                         │   │   │
│   │   │                                                             │   │   │
│   │   │   → 写入 devices 表的 pos_x, pos_y 字段                     │   │   │
│   │   │   → 清除 Redis 缓存                                         │   │   │
│   │   │   → 大屏自动刷新                                            │   │   │
│   │   │                                                             │   │   │
│   │   │                    [预览大屏]  [保存配置]  [重置]           │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 大屏实时数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        大屏 WebSocket 数据流                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    浏览器 (Dashboard)                    服务端 (Backend)                   │
│          │                                      │                           │
│          │   1. 建立连接                        │                           │
│          │   ws://server/ws/dashboard           │                           │
│          │─────────────────────────────────────▶│                           │
│          │                                      │                           │
│          │   2. 连接确认                        │                           │
│          │◀─────────────────────────────────────│                           │
│          │   {"type":"connected","ts":...}      │                           │
│          │                                      │                           │
│    ┌─────┴──────────────────────────────────────┴─────┐                    │
│    │                    循环推送 (1秒/次)              │                    │
│    └─────┬──────────────────────────────────────┬─────┘                    │
│          │                                      │                           │
│          │   3. 实时数据推送                    │                           │
│          │◀─────────────────────────────────────│                           │
│          │   {                                  │                           │
│          │     "type": "realtime",              │                           │
│          │     "data": [                        │                           │
│          │       {"sn":"A001","ppm":50,         │                           │
│          │        "status":"online"},           │                           │
│          │       {"sn":"A015","ppm":1200,       │                           │
│          │        "status":"alarm"},            │                           │
│          │       {"sn":"A003","ppm":null,       │                           │
│          │        "status":"offline"}           │                           │
│          │     ],                               │                           │
│          │     "ts": 1734320000                 │                           │
│          │   }                                  │                           │
│          │                                      │                           │
│          │   4. 收到数据后更新DOM               │                           │
│          │   ┌───────────────────────────────┐  │                           │
│          │   │ • 更新数值显示                │  │                           │
│          │   │ • 更新状态颜色 (绿/红/灰)     │  │                           │
│          │   │ • 报警设备触发闪烁动画        │  │                           │
│          │   │ • 更新顶部统计数字            │  │                           │
│          │   └───────────────────────────────┘  │                           │
│          │                                      │                           │
│    ┌─────┴──────────────────────────────────────┴─────┐                    │
│    │                    用户交互                       │                    │
│    └─────┬──────────────────────────────────────┬─────┘                    │
│          │                                      │                           │
│          │   5. 点击设备图标                    │                           │
│          │─────────────────────────────────────▶│                           │
│          │   {"type":"subscribe","sn":"A001"}   │                           │
│          │                                      │                           │
│          │   6. 返回该设备历史数据              │                           │
│          │◀─────────────────────────────────────│                           │
│          │   {                                  │                           │
│          │     "type": "history",               │                           │
│          │     "sn": "A001",                    │                           │
│          │     "data": [                        │                           │
│          │       {"ts":1734316400,"ppm":48},    │                           │
│          │       {"ts":1734316410,"ppm":52},    │                           │
│          │       ...                            │  ← 最近1小时, 每分钟1点   │
│          │     ]                                │                           │
│          │   }                                  │                           │
│          │                                      │                           │
│          │   7. 前端渲染趋势图 (ECharts)        │                           │
│          │   ┌───────────────────────────────┐  │                           │
│          │   │      ▲                        │  │                           │
│          │   │   ppm│    ╱╲                  │  │                           │
│          │   │      │___╱  ╲___╱╲___         │  │                           │
│          │   │      └──────────────▶ time    │  │                           │
│          │   └───────────────────────────────┘  │                           │
│          │                                      │                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 前端核心代码片段

**WebSocket 连接：**

```javascript
const ws = new WebSocket('wss://server/ws/dashboard');
ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'realtime') updateDevices(msg.data);
    if (msg.type === 'history') renderChart(msg.sn, msg.data);
};
```

**设备状态渲染：**

```javascript
function updateDevices(devices) {
    devices.forEach(d => {
        const el = document.getElementById(`device-${d.sn}`);
        el.querySelector('.value').textContent = d.ppm ?? '--';
        el.className = `device ${d.status}`;  // online/offline/alarm
    });
}
```

---

## 7. 安全层：授权与防护机制

### 7.1 整体安全架构 (续)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          安全防护体系 (续)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         商业保护                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │   │
│   │   │ 机器码绑定  │───▶│ 在线校验    │───▶│ 宽限期机制              │ │   │
│   │   │             │    │             │    │                         │ │   │
│   │   │ 读取宿主机  │    │ 每日凌晨    │    │ 断网72小时内可运行      │ │   │
│   │   │ machine-id  │    │ 向授权服务  │    │ 超时自动锁死            │ │   │
│   │   │ 防止镜像    │    │ 器验证      │    │ 需联系厂商解锁          │ │   │
│   │   │ 复制盗用    │    │             │    │                         │ │   │
│   │   └─────────────┘    └─────────────┘    └─────────────────────────┘ │   │
│   │                                                                      │   │
│   │   防护效果:                                                          │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  ✗ 客户复制Docker镜像到新服务器 → machine-id变化 → 验证失败  │   │   │
│   │   │  ✗ 客户修改授权文件 → 在线校验失败 → 系统锁死               │   │   │
│   │   │  ✗ 客户断网运行 → 72小时后Token过期 → 系统锁死              │   │   │
│   │   │  ✓ 正常客户 → 每日静默验证 → 持续运行                       │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         数据安全                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                      │   │
│   │   存储加密:                          访问控制:                       │   │
│   │   ┌─────────────────────┐            ┌─────────────────────┐        │   │
│   │   │ • 敏感配置AES加密   │            │ • API接口鉴权       │        │   │
│   │   │ • 数据库密码环境变量│            │ • 操作日志审计      │        │   │
│   │   │ • R2传输HTTPS       │            │ • IP白名单 (可选)   │        │   │
│   │   └─────────────────────┘            └─────────────────────┘        │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 设备认证流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          设备接入认证流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   出厂阶段                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   1. 生成设备凭证 (工厂烧录)                                         │   │
│   │                                                                      │   │
│   │      设备SN: MCS-A001-20251217                                       │   │
│   │      MQTT用户名: device_MCS-A001-20251217                            │   │
│   │      MQTT密码: SHA256(SN + 厂商密钥)[:16]                            │   │
│   │                                                                      │   │
│   │   2. 同步至服务端                                                    │   │
│   │                                                                      │   │
│   │      → 写入 Mosquitto passwd 文件                                    │   │
│   │      → 写入 数据库 devices 表                                        │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   设备上线                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   设备                    Mosquitto                Worker            │   │
│   │     │                         │                      │               │   │
│   │     │  CONNECT                │                      │               │   │
│   │     │  user: device_A001      │                      │               │   │
│   │     │  pass: abc123...        │                      │               │   │
│   │     │─────────────────────────▶                      │               │   │
│   │     │                         │                      │               │   │
│   │     │                    验证密码                    │               │   │
│   │     │                    ┌────┴────┐                 │               │   │
│   │     │                    │ passwd  │                 │               │   │
│   │     │                    │ 文件    │                 │               │   │
│   │     │                    └────┬────┘                 │               │   │
│   │     │                         │                      │               │   │
│   │     │                    验证ACL权限                 │               │   │
│   │     │                    ┌────┴────┐                 │               │   │
│   │     │                    │ acl     │                 │               │   │
│   │     │                    │ 文件    │                 │               │   │
│   │     │                    └────┬────┘                 │               │   │
│   │     │                         │                      │               │   │
│   │     │  CONNACK (成功)         │                      │               │   │
│   │     │◀─────────────────────────                      │               │   │
│   │     │                         │                      │               │   │
│   │     │  PUBLISH mcs/A001/up    │                      │               │   │
│   │     │─────────────────────────▶                      │               │   │
│   │     │                         │  转发                │               │   │
│   │     │                         │─────────────────────▶│               │   │
│   │     │                         │                      │               │   │
│   │     │                         │              检查设备是否已注册      │   │
│   │     │                         │              ┌───────┴───────┐       │   │
│   │     │                         │              │ 查询DB/Redis  │       │   │
│   │     │                         │              └───────┬───────┘       │   │
│   │     │                         │                      │               │   │
│   │     │                         │              已注册 → 正常处理       │   │
│   │     │                         │              未注册 → 丢弃+告警      │   │
│   │     │                         │                      │               │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 API 鉴权机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          管理后台 API 鉴权                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         JWT Token 流程                               │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   登录                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   浏览器                                            Backend          │   │
│   │      │                                                 │             │   │
│   │      │  POST /api/auth/login                           │             │   │
│   │      │  {"username": "admin", "password": "xxx"}       │             │   │
│   │      │────────────────────────────────────────────────▶│             │   │
│   │      │                                                 │             │   │
│   │      │                                          验证密码             │   │
│   │      │                                          生成Token            │   │
│   │      │                                                 │             │   │
│   │      │  {"access_token": "eyJ...", "expires": 86400}   │             │   │
│   │      │◀────────────────────────────────────────────────│             │   │
│   │      │                                                 │             │   │
│   │   存储Token到localStorage                              │             │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   API请求                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   浏览器                                            Backend          │   │
│   │      │                                                 │             │   │
│   │      │  GET /api/devices                               │             │   │
│   │      │  Authorization: Bearer eyJ...                   │             │   │
│   │      │────────────────────────────────────────────────▶│             │   │
│   │      │                                                 │             │   │
│   │      │                                        ┌────────┴────────┐    │   │
│   │      │                                        │ JWT中间件验证   │    │   │
│   │      │                                        │ • 签名正确?     │    │   │
│   │      │                                        │ • 未过期?       │    │   │
│   │      │                                        │ • 用户有效?     │    │   │
│   │      │                                        └────────┬────────┘    │   │
│   │      │                                                 │             │   │
│   │      │                                          验证通过             │   │
│   │      │                                          处理请求             │   │
│   │      │                                                 │             │   │
│   │      │  {"devices": [...]}                             │             │   │
│   │      │◀────────────────────────────────────────────────│             │   │
│   │      │                                                 │             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Token结构                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   Header: {"alg": "HS256", "typ": "JWT"}                            │   │
│   │   Payload: {                                                         │   │
│   │     "sub": "admin",           // 用户名                              │   │
│   │     "role": "admin",          // 角色                                │   │
│   │     "iat": 1734320000,        // 签发时间                            │   │
│   │     "exp": 1734406400         // 过期时间 (24小时后)                 │   │
│   │   }                                                                  │   │
│   │   Signature: HMAC-SHA256(header + payload, SECRET_KEY)              │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**核心代码片段：**

```python
from fastapi import Depends, HTTPException
from jose import jwt

def get_current_user(token: str = Depends(oauth2_scheme)):
    payload = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
    if payload.get("exp") < time.time():
        raise HTTPException(401, "Token expired")
    return payload.get("sub")
```

---

## 8. 运维层：部署与监控

### 8.1 一键部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          部署流程                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      部署包结构                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   mcs-iot-deploy/                                                           │
│   ├── docker-compose.yml          # 容器编排主文件                          │
│   ├── .env.example                # 环境变量模板                            │
│   ├── install.sh                  # 一键安装脚本                            │
│   │                                                                         │
│   ├── nginx/                                                                │
│   │   ├── nginx.conf              # Nginx配置                               │
│   │   └── ssl/                    # SSL证书目录 (空, 启动后自动申请)        │
│   │                                                                         │
│   ├── mosquitto/                                                            │
│   │   ├── mosquitto.conf          # MQTT配置                                │
│   │   ├── passwd                  # 认证文件 (空, 动态生成)                 │
│   │   └── acl                     # ACL规则                                 │
│   │                                                                         │
│   ├── worker/                                                               │
│   │   ├── Dockerfile              # Worker镜像构建                          │
│   │   ├── requirements.txt        # Python依赖                              │
│   │   └── src/                    # 源代码                                  │
│   │                                                                         │
│   ├── backend/                                                              │
│   │   ├── Dockerfile              # Backend镜像构建                         │
│   │   └── src/                    # API源代码                               │
│   │                                                                         │
│   ├── frontend/                                                             │
│   │   └── dist/                   # 前端编译产物                            │
│   │                                                                         │
│   └── scripts/                                                              │
│       ├── backup.sh               # 数据库备份脚本                          │
│       └── update.sh               # 系统更新脚本                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Docker Compose 配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      docker-compose.yml 结构                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   version: '3.8'                                                            │
│                                                                             │
│   services:                                                                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  nginx:                                                              │   │
│   │    image: nginx:alpine                                               │   │
│   │    ports:                                                            │   │
│   │      - "80:80"                                                       │   │
│   │      - "443:443"                                                     │   │
│   │    volumes:                                                          │   │
│   │      - ./nginx/nginx.conf:/etc/nginx/nginx.conf                      │   │
│   │      - ./nginx/ssl:/etc/nginx/ssl                                    │   │
│   │      - ./frontend/dist:/usr/share/nginx/html                         │   │
│   │    depends_on: [backend]                                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  mosquitto:                                                          │   │
│   │    image: eclipse-mosquitto:2                                        │   │
│   │    ports:                                                            │   │
│   │      - "8883:8883"                                                   │   │
│   │    volumes:                                                          │   │
│   │      - ./mosquitto:/mosquitto/config                                 │   │
│   │      - ./nginx/ssl:/mosquitto/certs                                  │   │
│   │      - mosquitto_data:/mosquitto/data                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  timescaledb:                                                        │   │
│   │    image: timescale/timescaledb:latest-pg15                          │   │
│   │    environment:                                                      │   │
│   │      POSTGRES_DB: ${DB_NAME}                                         │   │
│   │      POSTGRES_USER: ${DB_USER}                                       │   │
│   │      POSTGRES_PASSWORD: ${DB_PASS}                                   │   │
│   │    volumes:                                                          │   │
│   │      - pg_data:/var/lib/postgresql/data                              │   │
│   │    # 不暴露端口,仅内部访问                                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  redis:                                                              │   │
│   │    image: redis:7-alpine                                             │   │
│   │    volumes:                                                          │   │
│   │      - redis_data:/data                                              │   │
│   │    command: redis-server --appendonly yes                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  worker:                                                             │   │
│   │    build: ./worker                                                   │   │
│   │    environment:                                                      │   │
│   │      - DB_HOST=timescaledb                                           │   │
│   │      - REDIS_HOST=redis                                              │   │
│   │      - MQTT_HOST=mosquitto                                           │   │
│   │    volumes:                                                          │   │
│   │      - /etc/machine-id:/app/host_id:ro    # 授权绑定                 │   │
│   │      - ./license.key:/app/license.key:ro                             │   │
│   │    depends_on: [timescaledb, redis, mosquitto]                       │   │
│   │    restart: always                                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  backend:                                                            │   │
│   │    build: ./backend                                                  │   │
│   │    environment:                                                      │   │
│   │      - DB_HOST=timescaledb                                           │   │
│   │      - REDIS_HOST=redis                                              │   │
│   │      - JWT_SECRET=${JWT_SECRET}                                      │   │
│   │    depends_on: [timescaledb, redis]                                  │   │
│   │    restart: always                                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   volumes:                                                                  │
│     pg_data:                                                                │
│     redis_data:                                                             │
│     mosquitto_data:                                                         │
│                                                                             │
│   networks:                                                                 │
│     default:                                                                │
│       name: mcs-net                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 一键安装脚本流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          install.sh 执行流程                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   运行命令: curl -fsSL https://install.metachip.com | bash                  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 1  │  环境检查                                              │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • 检查操作系统 (Ubuntu 20.04+/CentOS 7+)               │   │
│   │        │     • 检查内存 ≥ 2GB                                        │   │
│   │        │     • 检查磁盘 ≥ 20GB                                       │   │
│   │        │     • 检查端口 80/443/8883 未占用                           │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 2  │  安装 Docker                                           │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • 检测是否已安装                                        │   │
│   │        │     • 若无则自动安装 (官方脚本)                            │   │
│   │        │     • 安装 Docker Compose                                   │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 3  │  交互式配置                                            │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • 输入域名: mqtt.yourcompany.com                        │   │
│   │        │     • 输入邮箱: admin@yourcompany.com (用于SSL证书)         │   │
│   │        │     • 输入授权码: MCS-XXXX-XXXX-XXXX                        │   │
│   │        │     • 设置管理员密码                                        │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 4  │  下载部署包                                            │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • 从 release.metachip.com 下载最新版本                  │   │
│   │        │     • 解压到 /opt/mcs-iot/                                  │   │
│   │        │     • 生成 .env 配置文件                                    │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 5  │  申请 SSL 证书                                         │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • 使用 certbot/acme.sh 申请 Let's Encrypt 证书          │   │
│   │        │     • 配置自动续期定时任务                                  │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 6  │  启动服务                                              │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • docker-compose pull (拉取镜像)                        │   │
│   │        │     • docker-compose up -d (后台启动)                       │   │
│   │        │     • 等待健康检查通过                                      │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │ Step 7  │  初始化数据                                            │   │
│   │   └────┬────┘                                                        │   │
│   │        │     • 创建数据库表结构                                      │   │
│   │        │     • 创建TimescaleDB超表                                   │   │
│   │        │     • 创建管理员账号                                        │   │
│   │        ▼                                                             │   │
│   │   ┌─────────┐                                                        │   │
│   │   │  完成   │                                                        │   │
│   │   └─────────┘                                                        │   │
│   │        │                                                             │   │
│   │        ▼                                                             │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  ✅ 安装完成!                                                │   │   │
│   │   │                                                             │   │   │
│   │   │  管理后台: https://mqtt.yourcompany.com/admin               │   │   │
│   │   │  可视化大屏: https://mqtt.yourcompany.com/dashboard         │   │   │
│   │   │  MQTT地址: mqtt.yourcompany.com:8883                        │   │   │
│   │   │                                                             │   │   │
│   │   │  默认账号: admin                                            │   │   │
│   │   │  默认密码: (您设置的密码)                                   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.4 系统监控设计 (续)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          监控与告警体系 (续)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   GET /api/health (续)                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  {                                                                   │   │
│   │    "status": "healthy",                                              │   │
│   │    "timestamp": 1734320000,                                          │   │
│   │    "components": {                                                   │   │
│   │      "database": {"status": "up", "latency_ms": 5},                 │   │
│   │      "redis": {"status": "up", "latency_ms": 1},                    │   │
│   │      "mqtt": {"status": "up", "connections": 95},                   │   │
│   │      "worker": {"status": "up", "queue_size": 0},                   │   │
│   │      "license": {"status": "valid", "expires": "2026-12-31"},       │   │
│   │      "disk": {"status": "ok", "used_percent": 45}                   │   │
│   │    },                                                                │   │
│   │    "metrics": {                                                      │   │
│   │      "devices_online": 95,                                           │   │
│   │      "devices_total": 100,                                           │   │
│   │      "messages_per_min": 570,                                        │   │
│   │      "alarms_today": 3                                               │   │
│   │    }                                                                 │   │
│   │  }                                                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      监控指标采集                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌──────────────────┬───────────────────────────┬──────────────────────┐  │
│   │     指标类型      │         采集方式           │      告警阈值        │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ CPU使用率        │ Docker stats API          │ > 80% 持续5分钟      │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ 内存使用率       │ Docker stats API          │ > 85% 持续5分钟      │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ 磁盘使用率       │ df -h                     │ > 80%                │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ 设备在线率       │ Redis统计                 │ < 90%                │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ 消息吞吐量       │ Worker计数器              │ 突降50%              │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ API响应时间      │ Nginx日志分析             │ P95 > 500ms          │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ 数据库连接数     │ pg_stat_activity          │ > 80% 最大连接       │  │
│   ├──────────────────┼───────────────────────────┼──────────────────────┤  │
│   │ 授权状态         │ License模块               │ 宽限期 < 24小时      │  │
│   └──────────────────┴───────────────────────────┴──────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      定时任务列表                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────┬─────────────────┬─────────────────────────────────────┐  │
│   │   执行时间   │     任务名称     │             任务内容                 │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 每分钟      │ 设备状态检查    │ 扫描Redis, 标记离线设备, 触发报警   │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 每5分钟     │ 健康检查        │ 检查各组件状态, 异常则告警          │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 每小时      │ 统计汇总        │ 生成小时级统计数据                  │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 凌晨02:00   │ 数据归档        │ 导出3天前数据到R2, 清理本地         │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 凌晨03:00   │ 授权校验        │ 向授权服务器验证License有效性       │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 凌晨04:00   │ 数据库优化      │ VACUUM ANALYZE, 更新统计信息        │  │
│   ├─────────────┼─────────────────┼─────────────────────────────────────┤  │
│   │ 每周日03:00 │ 完整备份        │ pg_dump 全量备份到R2                │  │
│   └─────────────┴─────────────────┴─────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.5 日志管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          日志管理策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      日志分类与存储                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌──────────────────┬─────────────────┬───────────────┬────────────────┐  │
│   │     日志类型      │      来源        │    保留时间    │    存储位置    │  │
│   ├──────────────────┼─────────────────┼───────────────┼────────────────┤  │
│   │ 应用日志         │ Worker/Backend  │ 7天           │ Docker logs    │  │
│   ├──────────────────┼─────────────────┼───────────────┼────────────────┤  │
│   │ 访问日志         │ Nginx           │ 30天          │ /var/log/nginx │  │
│   ├──────────────────┼─────────────────┼───────────────┼────────────────┤  │
│   │ MQTT日志         │ Mosquitto       │ 7天           │ Docker logs    │  │
│   ├──────────────────┼─────────────────┼───────────────┼────────────────┤  │
│   │ 报警日志         │ alarm_logs表    │ 永久          │ PostgreSQL     │  │
│   ├──────────────────┼─────────────────┼───────────────┼────────────────┤  │
│   │ 操作审计         │ audit_logs表    │ 1年           │ PostgreSQL     │  │
│   └──────────────────┴─────────────────┴───────────────┴────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      日志格式规范                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   应用日志 (JSON格式):                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  {                                                                   │   │
│   │    "ts": "2025-12-17T14:30:25.123Z",                                │   │
│   │    "level": "INFO",                                                  │   │
│   │    "module": "worker.processor",                                     │   │
│   │    "msg": "Data processed",                                          │   │
│   │    "sn": "A001",                                                     │   │
│   │    "ppm": 50.5,                                                      │   │
│   │    "duration_ms": 2                                                  │   │
│   │  }                                                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   操作审计日志:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  INSERT INTO audit_logs (user, action, target, detail, ip, ts)      │   │
│   │  VALUES ('admin', 'UPDATE_DEVICE', 'A001',                          │   │
│   │          '{"high_limit": 1000 -> 1200}', '192.168.1.1', NOW());     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      日志轮转配置                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Docker daemon.json:                                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  {                                                                   │   │
│   │    "log-driver": "json-file",                                       │   │
│   │    "log-opts": {                                                     │   │
│   │      "max-size": "50m",        // 单文件最大50MB                     │   │
│   │      "max-file": "5"           // 最多保留5个文件                    │   │
│   │    }                                                                 │   │
│   │  }                                                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 成本与性能评估

### 9.1 成本明细表

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    成本估算 (以100台设备/年为基准)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      一次性成本                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌────────────────────┬──────────────┬─────────────────────────────────┐  │
│   │       项目          │     费用      │             说明                 │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 软件授权费         │ ¥XXXX        │ 根据设备数量阶梯定价            │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 部署实施费         │ ¥0 (自助)    │ 一键脚本安装, 无需人工          │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 域名注册           │ ¥60          │ 首年费用, .com 域名             │  │
│   └────────────────────┴──────────────┴─────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      年度运营成本                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌────────────────────┬──────────────┬─────────────────────────────────┐  │
│   │       项目          │   费用/年     │             说明                 │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 云服务器           │ ¥79 - ¥500   │ 阿里云2核2G经济型 或 4核4G      │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 域名续费           │ ¥60          │ 每年续费                        │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ SSL证书            │ ¥0           │ Let's Encrypt 免费              │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 对象存储 (R2)      │ ¥0           │ Cloudflare R2 免费额度内        │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 短信费用           │ ¥50 - ¥200   │ 按量付费, 约0.045元/条          │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 4G流量卡 (单卡)    │ ¥6.4         │ ¥32/5年卡, 年均成本             │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 4G流量卡 (100台)   │ ¥640         │ 100台设备总计                   │  │
│   ├────────────────────┼──────────────┼─────────────────────────────────┤  │
│   │ 软件维护费         │ ¥0 或 XX%    │ 可选, 首年通常免费              │  │
│   ├────────────────────┴──────────────┴─────────────────────────────────┤  │
│   │                                                                      │  │
│   │  📊 年度总成本估算: ¥189 - ¥1400 (不含软件授权)                     │  │
│   │                                                                      │  │
│   │  对比传统方案 (¥50,000+/年), 节省 97% 以上                          │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 性能容量规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          性能基准与容量规划                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      服务器规格 vs 承载能力                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌───────────────┬────────────────┬────────────────┬────────────────────┐ │
│   │    服务器规格   │   设备容量      │   数据频率      │      适用场景       │ │
│   ├───────────────┼────────────────┼────────────────┼────────────────────┤ │
│   │ 2核2G 5M      │ 100-200台      │ 10秒/次        │ 小型化工厂          │ │
│   │ (经济型)      │                │                │ 年费 ¥79-200       │ │
│   ├───────────────┼────────────────┼────────────────┼────────────────────┤ │
│   │ 2核4G 5M      │ 200-500台      │ 10秒/次        │ 中型化工厂          │ │
│   │ (标准型)      │                │                │ 年费 ¥500-800      │ │
│   ├───────────────┼────────────────┼────────────────┼────────────────────┤ │
│   │ 4核8G 10M     │ 500-1000台     │ 5秒/次         │ 大型化工园区        │ │
│   │ (高配型)      │                │                │ 年费 ¥1500-3000    │ │
│   └───────────────┴────────────────┴────────────────┴────────────────────┘ │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      资源消耗估算 (2核2G服务器)                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   100台设备, 10秒/次上报:                                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   消息处理:                                                          │   │
│   │   ├─ 消息量: 100台 × 6次/分 = 600 条/分钟 = 10 条/秒                │   │
│   │   ├─ CPU占用: 约 3-5% (空闲状态)                                    │   │
│   │   └─ 峰值CPU: 约 15-20% (全量报警场景)                              │   │
│   │                                                                      │   │
│   │   内存分配:                                                          │   │
│   │   ├─ TimescaleDB:  ~600 MB                                          │   │
│   │   ├─ Redis:        ~100 MB                                          │   │
│   │   ├─ Mosquitto:    ~50 MB                                           │   │
│   │   ├─ Worker:       ~150 MB                                          │   │
│   │   ├─ Backend:      ~100 MB                                          │   │
│   │   ├─ Nginx:        ~30 MB                                           │   │
│   │   └─ 总计:         ~1030 MB (2G内存安全)                            │   │
│   │                                                                      │   │
│   │   存储消耗 (压缩后):                                                 │   │
│   │   ├─ 日增量:  ~8 MB                                                 │   │
│   │   ├─ 热数据:  ~25 MB (3天)                                          │   │
│   │   ├─ 索引:    ~10 MB                                                │   │
│   │   ├─ 日志:    ~50 MB/周                                             │   │
│   │   └─ 系统:    ~5 GB                                                 │   │
│   │                                                                      │   │
│   │   40GB硬盘剩余: ~33 GB, 可支撑多年运行                              │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      网络流量估算                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   设备端 (单台/月):                                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   默认模式 (10秒/次):                                                │   │
│   │   ├─ 上行: 200B × 6 × 60 × 24 × 30 = 51.84 MB/月                   │   │
│   │   ├─ 下行: 心跳响应 ~5 MB/月                                        │   │
│   │   └─ 合计: ~57 MB/月 (5年1GB卡绰绰有余)                             │   │
│   │                                                                      │   │
│   │   调试模式 (1秒/次, 限时10分钟):                                     │   │
│   │   ├─ 临时流量: 200B × 60 × 10 = 117 KB                              │   │
│   │   └─ 影响可控                                                        │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   服务端 (100台/月):                                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │   入站流量:  ~6 GB/月 (设备上报)                                    │   │
│   │   出站流量:  ~1 GB/月 (大屏+API)                                    │   │
│   │   归档上传:  ~150 MB/月 (R2)                                        │   │
│   │   ─────────────────────                                              │   │
│   │   总计:      ~7.2 GB/月 (5M带宽充足)                                │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.3 性能瓶颈与优化策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          瓶颈分析与优化策略                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌────────────────┬─────────────────────────┬──────────────────────────┐  │
│   │    潜在瓶颈     │        触发条件          │        优化策略           │  │
│   ├────────────────┼─────────────────────────┼──────────────────────────┤  │
│   │                │                         │                          │  │
│   │ CPU 过载       │ • 500+设备同时1秒上报   │ • 限制调试模式时长       │  │
│   │                │ • 大量报警同时触发      │ • 批量处理消息           │  │
│   │                │                         │ • 异步发送通知           │  │
│   │                │                         │                          │  │
│   ├────────────────┼─────────────────────────┼──────────────────────────┤  │
│   │                │                         │                          │  │
│   │ 内存溢出       │ • 数据库连接数过多      │ • 连接池限制 (max=20)    │  │
│   │                │ • Redis缓存膨胀         │ • 设置Key过期时间        │  │
│   │                │ • Worker内存泄漏        │ • 定期重启 (每周)        │  │
│   │                │                         │                          │  │
│   ├────────────────┼─────────────────────────┼──────────────────────────┤  │
│   │                │                         │                          │  │
│   │ 磁盘写满       │ • 归档任务失败          │ • 监控磁盘使用率         │  │
│   │                │ • 日志未轮转            │ • 归档失败告警           │  │
│   │                │                         │ • 手动清理脚本           │  │
│   │                │                         │                          │  │
│   ├────────────────┼─────────────────────────┼──────────────────────────┤  │
│   │                │                         │                          │  │
│   │ 4G流量超标     │ • 调试模式滥用          │ • 服务端限制调试时长     │  │
│   │                │ • 固件Bug高频上报       │ • 流量异常自动告警       │  │
│   │                │                         │ • OTA修复                │  │
│   │                │                         │                          │  │
│   ├────────────────┼─────────────────────────┼──────────────────────────┤  │
│   │                │                         │                          │  │
│   │ 数据库慢查询   │ • 大时间范围查询        │ • 查询限制 (最多7天)     │  │
│   │                │ • 未走索引              │ • 分页返回               │  │
│   │                │                         │ • 预聚合统计表           │  │
│   │                │                         │                          │  │
│   └────────────────┴─────────────────────────┴──────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 附录：接口规范与配置模板

### 10.1 REST API 接口清单 (续)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          REST API 接口列表 (续)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         设备管理                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   GET    /api/devices              获取设备列表 (支持分页、筛选)            │
│   POST   /api/devices              新增设备                                 │
│   GET    /api/devices/{sn}         获取单个设备详情                         │
│   PUT    /api/devices/{sn}         更新设备信息                             │
│   DELETE /api/devices/{sn}         删除设备                                 │
│   GET    /api/devices/{sn}/realtime  获取设备实时数据                       │
│   GET    /api/devices/{sn}/history   获取设备历史数据                       │
│   POST   /api/devices/{sn}/command   下发设备命令                           │
│   POST   /api/devices/positions    批量更新设备位置 (大屏配置)              │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         报警管理                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   GET    /api/alarms               获取报警记录列表                         │
│   GET    /api/alarms/{id}          获取报警详情                             │
│   POST   /api/alarms/{id}/ack      确认报警                                 │
│   GET    /api/alarms/stats         获取报警统计                             │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         配置管理                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   GET    /api/config/alarm         获取报警渠道配置                         │
│   PUT    /api/config/alarm         更新报警渠道配置                         │
│   POST   /api/config/alarm/test    测试报警渠道                             │
│   GET    /api/config/storage       获取存储配置 (R2)                        │
│   PUT    /api/config/storage       更新存储配置                             │
│   GET    /api/config/dashboard     获取大屏配置                             │
│   PUT    /api/config/dashboard     更新大屏配置                             │
│   POST   /api/config/dashboard/bg  上传大屏背景图                           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         系统管理                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   GET    /api/system/health        系统健康检查                             │
│   GET    /api/system/stats         系统运行统计                             │
│   GET    /api/system/license       授权信息                                 │
│   GET    /api/system/logs          系统操作日志                             │
│   GET    /api/system/archives      归档记录列表                             │
│   POST   /api/system/archives/{date}/download  下载归档文件                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        WebSocket 接口                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   WS     /ws/dashboard             大屏实时数据推送                         │
│                                                                             │
│          ↓ 服务端推送消息格式:                                              │
│          {"type":"realtime","data":[{"sn":"A001","ppm":50,"status":"ok"}]} │
│          {"type":"alarm","data":{"sn":"A015","ppm":1200,"type":"HIGH"}}    │
│                                                                             │
│          ↑ 客户端请求消息格式:                                              │
│          {"type":"subscribe","sn":"A001"}   请求单设备历史                  │
│          {"type":"ping"}                    心跳保活                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 典型接口请求/响应示例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          接口示例                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  示例1: 用户登录                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   请求:                                                                     │
│   POST /api/auth/login                                                      │
│   Content-Type: application/json                                            │
│                                                                             │
│   {"username": "admin", "password": "your_password"}                        │
│                                                                             │
│   响应 (200 OK):                                                            │
│   {                                                                         │
│     "access_token": "eyJhbGciOiJIUzI1NiIs...",                             │
│     "token_type": "bearer",                                                 │
│     "expires_in": 86400                                                     │
│   }                                                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  示例2: 获取设备列表                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   请求:                                                                     │
│   GET /api/devices?page=1&size=20&status=online                             │
│   Authorization: Bearer eyJhbGciOiJIUzI1NiIs...                             │
│                                                                             │
│   响应 (200 OK):                                                            │
│   {                                                                         │
│     "total": 95,                                                            │
│     "page": 1,                                                              │
│     "size": 20,                                                             │
│     "data": [                                                               │
│       {                                                                     │
│         "sn": "MCS-A001-20251217",                                         │
│         "name": "1号储罐检测点",                                            │
│         "location": "A区东侧",                                              │
│         "status": "online",                                                 │
│         "last_ppm": 45.2,                                                   │
│         "last_seen": "2025-12-17T14:30:00Z",                               │
│         "high_limit": 1000,                                                 │
│         "low_limit": null                                                   │
│       },                                                                    │
│       ...                                                                   │
│     ]                                                                       │
│   }                                                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  示例3: 获取设备历史数据                                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   请求:                                                                     │
│   GET /api/devices/MCS-A001-20251217/history?start=2025-12-17T00:00:00Z     │
│       &end=2025-12-17T14:00:00Z&interval=1m                                 │
│   Authorization: Bearer eyJhbGciOiJIUzI1NiIs...                             │
│                                                                             │
│   响应 (200 OK):                                                            │
│   {                                                                         │
│     "sn": "MCS-A001-20251217",                                             │
│     "start": "2025-12-17T00:00:00Z",                                       │
│     "end": "2025-12-17T14:00:00Z",                                         │
│     "interval": "1m",                                                       │
│     "points": [                                                             │
│       {"ts": "2025-12-17T00:00:00Z", "ppm": 42.1, "temp": 25.3},           │
│       {"ts": "2025-12-17T00:01:00Z", "ppm": 43.5, "temp": 25.2},           │
│       ...                                                                   │
│     ]                                                                       │
│   }                                                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  示例4: 更新报警配置                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   请求:                                                                     │
│   PUT /api/config/alarm                                                     │
│   Authorization: Bearer eyJhbGciOiJIUzI1NiIs...                             │
│   Content-Type: application/json                                            │
│                                                                             │
│   {                                                                         │
│     "email": {                                                              │
│       "enabled": true,                                                      │
│       "smtp_host": "smtp.qq.com",                                          │
│       "smtp_port": 587,                                                     │
│       "smtp_user": "alarm@company.com",                                    │
│       "smtp_pass": "authorization_code",                                    │
│       "recipients": ["admin@company.com", "safety@company.com"]            │
│     },                                                                      │
│     "webhook": {                                                            │
│       "enabled": true,                                                      │
│       "platform": "dingtalk",                                              │
│       "url": "https://oapi.dingtalk.com/robot/send?access_token=xxx",      │
│       "secret": "SECxxx"                                                    │
│     },                                                                      │
│     "sms": {                                                                │
│       "enabled": false                                                      │
│     },                                                                      │
│     "settings": {                                                           │
│       "debounce_minutes": 10,                                              │
│       "enable_schedule": true,                                              │
│       "schedule_days": [1, 2, 3, 4, 5],                                    │
│       "schedule_start": "08:00",                                           │
│       "schedule_end": "18:00"                                              │
│     }                                                                       │
│   }                                                                         │
│                                                                             │
│   响应 (200 OK):                                                            │
│   {"message": "配置已保存", "updated_at": "2025-12-17T14:35:00Z"}          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 环境变量配置模板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          .env 配置模板                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   # ============================================                            │
│   # MCS-IoT 系统配置文件                                                    │
│   # ============================================                            │
│                                                                             │
│   # ---------- 基础配置 ----------                                          │
│   DOMAIN=mqtt.yourcompany.com                                               │
│   ADMIN_EMAIL=admin@yourcompany.com                                         │
│                                                                             │
│   # ---------- 数据库配置 ----------                                        │
│   DB_HOST=timescaledb                                                       │
│   DB_PORT=5432                                                              │
│   DB_NAME=mcs_iot                                                           │
│   DB_USER=mcs_admin                                                         │
│   DB_PASS=your_strong_password_here                                         │
│                                                                             │
│   # ---------- Redis配置 ----------                                         │
│   REDIS_HOST=redis                                                          │
│   REDIS_PORT=6379                                                           │
│   REDIS_PASS=                                                               │
│                                                                             │
│   # ---------- MQTT配置 ----------                                          │
│   MQTT_HOST=mosquitto                                                       │
│   MQTT_PORT=1883                                                            │
│   MQTT_USER=worker                                                          │
│   MQTT_PASS=worker_password_here                                            │
│                                                                             │
│   # ---------- 安全配置 ----------                                          │
│   JWT_SECRET=your_jwt_secret_key_at_least_32_chars                          │
│   JWT_EXPIRE_HOURS=24                                                       │
│                                                                             │
│   # ---------- 授权配置 ----------                                          │
│   LICENSE_KEY=MCS-XXXX-XXXX-XXXX                                            │
│   LICENSE_SERVER=https://license.metachip.com/api/verify                    │
│                                                                             │
│   # ---------- R2存储配置 (可选, 也可在Admin界面配置) ----------            │
│   R2_ENDPOINT=https://xxx.r2.cloudflarestorage.com                          │
│   R2_ACCESS_KEY=your_r2_access_key                                          │
│   R2_SECRET_KEY=your_r2_secret_key                                          │
│   R2_BUCKET=mcs-archive                                                     │
│                                                                             │
│   # ---------- 运行配置 ----------                                          │
│   LOG_LEVEL=INFO                                                            │
│   TZ=Asia/Shanghai                                                          │
│   DATA_RETENTION_DAYS=3                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.4 MQTT Topic 规范

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          MQTT Topic 设计规范                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Topic 命名规则: mcs/{device_sn}/{direction}                               │
│                                                                             │
│   ┌─────────────────────┬───────────────────┬───────────────────────────┐  │
│   │       Topic          │      方向         │          用途              │  │
│   ├─────────────────────┼───────────────────┼───────────────────────────┤  │
│   │ mcs/{sn}/up         │ 设备 → 服务器     │ 数据上报                   │  │
│   ├─────────────────────┼───────────────────┼───────────────────────────┤  │
│   │ mcs/{sn}/cmd        │ 服务器 → 设备     │ 命令下发                   │  │
│   ├─────────────────────┼───────────────────┼───────────────────────────┤  │
│   │ mcs/{sn}/status     │ 设备 → 服务器     │ 状态变更 (可选)            │  │
│   ├─────────────────────┼───────────────────┼───────────────────────────┤  │
│   │ mcs/broadcast/cmd   │ 服务器 → 所有设备 │ 广播命令 (如全局OTA)       │  │
│   └─────────────────────┴───────────────────┴───────────────────────────┘  │
│                                                                             │
│   QoS 级别说明:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  • 数据上报 (mcs/{sn}/up):     QoS 0 (最多一次)                     │   │
│   │    - 理由: 数据量大, 丢失单条可接受, 节省带宽                       │   │
│   │                                                                      │   │
│   │  • 命令下发 (mcs/{sn}/cmd):    QoS 1 (至少一次)                     │   │
│   │    - 理由: 命令重要, 必须确保送达                                   │   │
│   │                                                                      │   │
│   │  • 广播命令:                   QoS 1                                 │   │
│   │    - 理由: OTA等关键操作必须可靠                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   遗嘱消息 (Last Will):                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Topic: mcs/{sn}/status                                              │   │
│   │  Payload: {"status": "offline", "ts": 1734320000}                   │   │
│   │  QoS: 1                                                              │   │
│   │  Retain: true                                                        │   │
│   │                                                                      │   │
│   │  用途: 设备异常断开时, Broker自动发布离线状态                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.5 错误码规范

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          错误码定义                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         HTTP 状态码                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌──────────┬──────────────────────────────────────────────────────────┐  │
│   │   状态码  │                       含义                               │  │
│   ├──────────┼──────────────────────────────────────────────────────────┤  │
│   │   200    │ 成功                                                     │  │
│   │   201    │ 创建成功                                                 │  │
│   │   400    │ 请求参数错误                                             │  │
│   │   401    │ 未认证 (Token无效或过期)                                 │  │
│   │   403    │ 无权限 / 系统已锁定 (授权失效)                           │  │
│   │   404    │ 资源不存在                                               │  │
│   │   429    │ 请求过于频繁                                             │  │
│   │   500    │ 服务器内部错误                                           │  │
│   │   503    │ 服务暂不可用 (维护中)                                    │  │
│   └──────────┴──────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         业务错误码                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   响应格式:                                                                 │
│   {"code": 40001, "message": "设备不存在", "detail": "SN: A999"}           │
│                                                                             │
│   ┌──────────┬──────────────────────────────────────────────────────────┐  │
│   │  错误码   │                       含义                               │  │
│   ├──────────┼──────────────────────────────────────────────────────────┤  │
│   │  10001   │ 用户名或密码错误                                         │  │
│   │  10002   │ Token已过期                                              │  │
│   │  10003   │ 权限不足                                                 │  │
│   ├──────────┼──────────────────────────────────────────────────────────┤  │
│   │  20001   │ 授权无效                                                 │  │
│   │  20002   │ 授权已过期                                               │  │
│   │  20003   │ 设备数量超出授权限制                                     │  │
│   │  20004   │ 机器码不匹配 (疑似盗版)                                  │  │
│   ├──────────┼──────────────────────────────────────────────────────────┤  │
│   │  40001   │ 设备不存在                                               │  │
│   │  40002   │ 设备SN已存在                                             │  │
│   │  40003   │ 设备离线, 无法下发命令                                   │  │
│   │  40004   │ 校准参数无效                                             │  │
│   ├──────────┼──────────────────────────────────────────────────────────┤  │
│   │  50001   │ 报警配置无效                                             │  │
│   │  50002   │ 邮件发送失败                                             │  │
│   │  50003   │ Webhook调用失败                                          │  │
│   │  50004   │ 短信发送失败                                             │  │
│   ├──────────┼──────────────────────────────────────────────────────────┤  │
│   │  60001   │ R2配置无效                                               │  │
│   │  60002   │ 归档上传失败                                             │  │
│   │  60003   │ 归档文件不存在                                           │  │
│   └──────────┴──────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.6 设备固件错误码

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          设备端错误码 (上报字段 err)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┬──────────────────────────┬───────────────────────────────┐  │
│   │  错误码   │          含义            │           处理建议             │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │    0     │ 正常                     │ 无需处理                       │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │    1     │ 传感器读取失败           │ 检查传感器连接/更换            │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │    2     │ 传感器数据异常           │ 可能需要校准                   │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │    3     │ 温度传感器故障           │ 检查温度传感器                 │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   10     │ 电量低 (<20%)            │ 尽快更换电池/充电              │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   11     │ 电量极低 (<10%)          │ 立即处理, 可能即将离线         │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   20     │ 网络信号弱 (RSSI<-100)   │ 检查天线/更换安装位置          │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   21     │ SIM卡异常                │ 检查SIM卡/联系运营商           │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   30     │ 存储器满                 │ 离线缓存已满, 可能丢数据       │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   40     │ 看门狗重启               │ 记录异常, 可能固件Bug          │  │
│   ├──────────┼──────────────────────────┼───────────────────────────────┤  │
│   │   50     │ 校准参数丢失             │ 需要重新校准                   │  │
│   └──────────┴──────────────────────────┴───────────────────────────────┘  │
│                                                                             │
│   服务端处理逻辑:                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  if err > 0:                                                         │   │
│   │      log.warning(f"Device {sn} reported error: {err}")              │   │
│   │      if err in [1, 2, 10, 11]:                                       │   │
│   │          trigger_device_alarm(sn, err)  # 触发设备异常报警           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📎 附录：快速参考卡片 (续)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          MCS-IoT 快速参考卡片 (续)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   📊 关键SQL查询 (续)                                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  -- 查看在线设备数                                                   │   │
│   │  SELECT COUNT(*) FROM devices WHERE status = 'online';              │   │
│   │                                                                      │   │
│   │  -- 最近1小时数据量                                                  │   │
│   │  SELECT COUNT(*) FROM sensor_data                                   │   │
│   │  WHERE time > NOW() - INTERVAL '1 hour';                            │   │
│   │                                                                      │   │
│   │  -- 今日报警统计                                                     │   │
│   │  SELECT alarm_type, COUNT(*) FROM alarm_logs                        │   │
│   │  WHERE triggered_at::date = CURRENT_DATE                            │   │
│   │  GROUP BY alarm_type;                                               │   │
│   │                                                                      │   │
│   │  -- 查看数据库大小                                                   │   │
│   │  SELECT pg_size_pretty(pg_database_size('mcs_iot'));                │   │
│   │                                                                      │   │
│   │  -- 查看各表大小                                                     │   │
│   │  SELECT relname, pg_size_pretty(pg_total_relation_size(relid))      │   │
│   │  FROM pg_catalog.pg_statio_user_tables ORDER BY 2 DESC;             │   │
│   │                                                                      │   │
│   │  -- 查看压缩状态                                                     │   │
│   │  SELECT * FROM timescaledb_information.compressed_chunk_stats;      │   │
│   │                                                                      │   │
│   │  -- 手动触发压缩                                                     │   │
│   │  SELECT compress_chunk(c) FROM show_chunks('sensor_data',           │   │
│   │         older_than => INTERVAL '1 day') c;                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   🔑 Redis常用命令                                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  # 进入Redis CLI                                                     │   │
│   │  docker-compose exec redis redis-cli                                 │   │
│   │                                                                      │   │
│   │  # 查看所有在线设备                                                  │   │
│   │  KEYS online:*                                                       │   │
│   │                                                                      │   │
│   │  # 查看某设备校准参数缓存                                            │   │
│   │  GET calib:MCS-A001-20251217                                        │   │
│   │                                                                      │   │
│   │  # 查看授权Token过期时间                                             │   │
│   │  TTL license:token                                                   │   │
│   │                                                                      │   │
│   │  # 清除所有缓存 (谨慎!)                                              │   │
│   │  FLUSHDB                                                             │   │
│   │                                                                      │   │
│   │  # 查看内存使用                                                      │   │
│   │  INFO memory                                                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   🦟 MQTT调试命令                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  # 订阅所有设备上报 (调试用)                                         │   │
│   │  mosquitto_sub -h localhost -p 1883 -u worker -P xxx -t 'mcs/+/up' │   │
│   │                                                                      │   │
│   │  # 发送测试命令给设备                                                │   │
│   │  mosquitto_pub -h localhost -p 1883 -u worker -P xxx \              │   │
│   │    -t 'mcs/A001/cmd' -m '{"cmd":"debug","duration":60}'             │   │
│   │                                                                      │   │
│   │  # 查看Broker状态                                                    │   │
│   │  mosquitto_sub -h localhost -t '$SYS/#' -v                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   📁 重要文件路径                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  /opt/mcs-iot/                     # 安装根目录                      │   │
│   │  ├── docker-compose.yml            # 容器编排                        │   │
│   │  ├── .env                          # 环境配置                        │   │
│   │  ├── license.key                   # 授权文件                        │   │
│   │  ├── data/                                                           │   │
│   │  │   ├── postgres/                 # 数据库文件                      │   │
│   │  │   └── redis/                    # Redis持久化                     │   │
│   │  ├── nginx/                                                          │   │
│   │  │   ├── nginx.conf                # Nginx配置                       │   │
│   │  │   └── ssl/                      # SSL证书                         │   │
│   │  ├── mosquitto/                                                      │   │
│   │  │   ├── mosquitto.conf            # MQTT配置                        │   │
│   │  │   ├── passwd                    # 设备密码                        │   │
│   │  │   └── acl                       # 权限规则                        │   │
│   │  └── logs/                         # 日志目录                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   🚨 紧急故障处理                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │  【所有设备离线】                                                    │   │
│   │  1. docker-compose ps              # 检查容器状态                    │   │
│   │  2. docker-compose logs mosquitto  # 查看MQTT日志                    │   │
│   │  3. docker-compose restart mosquitto                                │   │
│   │                                                                      │   │
│   │  【系统锁死 (403)】                                                  │   │
│   │  1. 检查网络是否能访问 license.metachip.com                         │   │
│   │  2. 检查 license.key 文件是否存在                                   │   │
│   │  3. 联系厂商获取新授权                                              │   │
│   │                                                                      │   │
│   │  【磁盘满】                                                          │   │
│   │  1. df -h                          # 确认磁盘状态                    │   │
│   │  2. docker system prune -a         # 清理Docker                     │   │
│   │  3. 手动执行归档: docker-compose exec worker python archive.py     │   │
│   │                                                                      │   │
│   │  【数据库无法连接】                                                  │   │
│   │  1. docker-compose logs timescaledb                                 │   │
│   │  2. docker-compose restart timescaledb                              │   │
│   │  3. 如持续失败, 检查磁盘空间和数据目录权限                          │   │
│   │                                                                      │   │
│   │  【报警不发送】                                                      │   │
│   │  1. Admin后台检查报警渠道开关                                       │   │
│   │  2. 点击"测试发送"验证配置                                          │   │
│   │  3. 检查防抖设置是否过长                                            │   │
│   │  4. docker-compose logs worker | grep alarm                         │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   📞 技术支持                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  官方网站:    https://www.metachip.com                              │   │
│   │  技术邮箱:    support@metachip.com                                  │   │
│   │  文档中心:    https://docs.metachip.com/mcs-iot                     │   │
│   │  授权服务:    https://license.metachip.com                          │   │
│   │  紧急热线:    400-XXX-XXXX (工作日 9:00-18:00)                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 版本历史

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          文档版本历史                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┬────────────┬─────────────────────────────────────────────┐  │
│   │   版本    │    日期     │                  变更内容                    │  │
│   ├──────────┼────────────┼─────────────────────────────────────────────┤  │
│   │  v1.0    │ 2025-12-01 │ 初始版本, 基础架构设计                      │  │
│   ├──────────┼────────────┼─────────────────────────────────────────────┤  │
│   │  v1.5    │ 2025-12-10 │ 新增报警渠道独立配置, 完善授权机制          │  │
│   ├──────────┼────────────┼─────────────────────────────────────────────┤  │
│   │  v2.0    │ 2025-12-17 │ 完整技术执行手册:                           │  │
│   │          │            │ - 新增架构框图                              │  │
│   │          │            │ - 补充冷热分离详细流程                      │  │
│   │          │            │ - 完善API接口规范                           │  │
│   │          │            │ - 添加运维快速参考                          │  │
│   │          │            │ - 优化成本评估模型                          │  │
│   └──────────┴────────────┴─────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔚 文档结束

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                                                                             │
│         ███╗   ███╗ ██████╗███████╗      ██╗ ██████╗ ████████╗             │
│         ████╗ ████║██╔════╝██╔════╝      ██║██╔═══██╗╚══██╔══╝             │
│         ██╔████╔██║██║     ███████╗█████╗██║██║   ██║   ██║                │
│         ██║╚██╔╝██║██║     ╚════██║╚════╝██║██║   ██║   ██║                │
│         ██║ ╚═╝ ██║╚██████╗███████║      ██║╚██████╔╝   ██║                │
│         ╚═╝     ╚═╝ ╚═════╝╚══════╝      ╚═╝ ╚═════╝    ╚═╝                │
│                                                                             │
│                    元芯传感 · 工业物联网解决方案                              │
│                                                                             │
│                         文档版本: v2.0 Final                                │
│                         更新日期: 2025年12月17日                             │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────    │
│                                                                             │
│   本文档为元芯传感 MCS-IoT 系统的完整技术执行手册。                          │
│                                                                             │
│   包含内容:                                                                 │
│     ✓ 五层系统架构设计与框图                                                │
│     ✓ 硬件通信协议与固件规范                                                │
│     ✓ 服务端核心处理逻辑                                                    │
│     ✓ 数据库设计与冷热分离策略                                              │
│     ✓ 管理后台与可视化大屏功能                                              │
│     ✓ 安全防护与商业授权机制                                                │
│     ✓ 部署运维与监控方案                                                    │
│     ✓ 成本估算与性能规划                                                    │
│     ✓ API接口与配置规范                                                     │
│                                                                             │
│   适用对象:                                                                 │
│     • 项目经理 - 整体方案理解与项目规划                                     │
│     • 硬件工程师 - 固件开发与通信协议实现                                   │
│     • 软件工程师 - 后端开发与前端实现                                       │
│     • 运维人员 - 系统部署与日常维护                                         │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────    │
│                                                                             │
│                     © 2025  Ryan Zhi 保留所有权利                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
