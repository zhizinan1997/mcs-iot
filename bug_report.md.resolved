# MCS-IoT ä¼ æ„Ÿå™¨ç¦»çº¿é—®é¢˜æŠ€æœ¯æŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-12-30  
**é—®é¢˜çŠ¶æ€**: âœ… å·²è§£å†³  
**ä¸¥é‡ç­‰çº§**: é«˜ï¼ˆå½±å“æ‰€æœ‰ä¼ æ„Ÿå™¨ä¸Šçº¿ï¼‰

---

## é—®é¢˜æè¿°

Docker éƒ¨ç½² MCS-IoT å¹³å°åï¼Œå¯åŠ¨ 24 åªæ¨¡æ‹Ÿä¼ æ„Ÿå™¨çš„è„šæœ¬ï¼Œåå°ç®¡ç†ç½‘é¡µæ˜¾ç¤ºæ‰€æœ‰ä¼ æ„Ÿå™¨**ç¦»çº¿çŠ¶æ€**ã€‚

---

## æ ¹æœ¬åŸå› åˆ†æ

### Bug 1: MQTT é…ç½®æ–‡ä»¶ä½¿ç”¨å ä½ç¬¦ï¼Œæœªè‡ªåŠ¨é…ç½®å®é™…å‡­æ®

**é—®é¢˜ä½ç½®**: [/mosquitto/config/mqtt_config.json](file:///opt/mcs-iot/mosquitto/config/mqtt_config.json)

éƒ¨ç½²åè¯¥æ–‡ä»¶å†…å®¹ä»ä¸ºå ä½ç¬¦ï¼š

```json
{
    "device_user": "YOUR_DEVICE_USER",
    "device_pass": "YOUR_DEVICE_PASS",
    "worker_user": "YOUR_WORKER_USER",
    "worker_pass": "YOUR_WORKER_PASS"
}
```

**å½±å“èŒƒå›´**:
- Worker æœåŠ¡æ— æ³•è¿æ¥ MQTTï¼ˆMQTT è¿”å›ç  5ï¼šè®¤è¯å¤±è´¥ï¼‰
- æ¨¡æ‹Ÿå™¨è„šæœ¬æ— æ³•è¿æ¥ MQTT

**æ—¥å¿—è¡¨ç°**:
```
mqtt_client: Loaded MQTT config from file: user=YOUR_WORKER_USER
mqtt_client: Failed to connect, return code 5
```

---

### Bug 2: Mosquitto ACL é…ç½®ç¼ºå°‘è®¾å¤‡ç”¨æˆ·çš„å‘å¸ƒæƒé™

**é—®é¢˜ä½ç½®**: [/mosquitto/config/acl](file:///opt/mcs-iot/mosquitto/config/acl)

åŸå§‹ ACL é…ç½®ï¼š
```
user admin
topic readwrite #

user worker
topic read mcs/+/up

pattern write mcs/%c/up
```

`pattern` è§„åˆ™ä»…å¯¹åŒ¹é… client_id çš„ç”¨æˆ·ç”Ÿæ•ˆï¼Œä½†è®¾å¤‡/æ¨¡æ‹Ÿå™¨ä½¿ç”¨çš„ `zhizinan` ç”¨æˆ·æœªåœ¨ ACL ä¸­æ˜ç¡®æˆæƒã€‚

---

### Bug 3: Mosquitto å¯†ç æ–‡ä»¶ä¸é…ç½®ä¸åŒæ­¥

**é—®é¢˜ä½ç½®**: `/mosquitto/config/passwd`

éƒ¨ç½²è„šæœ¬åˆ›å»ºäº†ç”¨æˆ· `zhizinan`ã€`worker`ã€[admin](file:///opt/mcs-iot/scripts/demo_generator.py#95-107)ï¼Œä½†ï¼š
1. å¯†ç ä¸ [mqtt_config.json](file:///opt/mcs-iot/scripts/mqtt_config.json) ä¸­é…ç½®çš„å¯†ç ä¸ä¸€è‡´
2. å¯†ç æ–‡ä»¶ä¸­çš„ç”¨æˆ·å¯†ç æœªä¸ [.env](file:///opt/mcs-iot/.env) æ–‡ä»¶åŒæ­¥

---

## é—®é¢˜é“¾è·¯å›¾

```mermaid
flowchart TD
    A[æ¨¡æ‹Ÿå™¨å¯åŠ¨] --> B{è¯»å– mqtt_config.json}
    B --> C[è·å–ç”¨æˆ·å: zhizinan]
    C --> D{è¿æ¥ MQTT Broker}
    D --> E{å¯†ç éªŒè¯}
    E -->|å¯†ç é”™è¯¯| F[è¿”å›ç  5: è®¤è¯å¤±è´¥]
    F --> G[ä¼ æ„Ÿå™¨æ— æ³•å‘é€æ•°æ®]
    
    H[Worker æœåŠ¡å¯åŠ¨] --> I{è¯»å–å®¹å™¨å†… mqtt_config.json}
    I --> J[ç”¨æˆ·å: YOUR_WORKER_USER]
    J --> K{è¿æ¥ MQTT Broker}
    K -->|ç”¨æˆ·ä¸å­˜åœ¨| L[è¿”å›ç  5: è®¤è¯å¤±è´¥]
    L --> M[Worker æ— æ³•è®¢é˜…æ¶ˆæ¯]
    
    G --> N[åå°æ˜¾ç¤ºä¼ æ„Ÿå™¨ç¦»çº¿]
    M --> N
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ›´æ–° MQTT é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: [/mosquitto/config/mqtt_config.json](file:///opt/mcs-iot/mosquitto/config/mqtt_config.json)ï¼ˆWorker å®¹å™¨æŒ‚è½½è·¯å¾„ï¼‰

```json
{
    "device_user": "zhizinan",
    "device_pass": "admin123",
    "worker_user": "worker", 
    "worker_pass": "admin123",
    "admin_user": "admin",
    "admin_pass": "admin123"
}
```

### 2. æ›´æ–° ACL é…ç½®

**æ–‡ä»¶**: [/mosquitto/config/acl](file:///opt/mcs-iot/mosquitto/config/acl)

```diff
 # ACL for MCS-IoT
 
 user admin
 topic readwrite #
 
 user worker
 topic read mcs/+/up
 topic write mcs/+/cmd
 topic read mcs/+/status
 
+# Device/Simulator User
+user zhizinan
+topic write mcs/+/up
+topic write mcs/+/status
+
 pattern write mcs/%c/up
 pattern read mcs/%c/cmd
 pattern write mcs/%c/status
```

### 3. åŒæ­¥ Mosquitto å¯†ç 

```bash
docker exec mcs_mosquitto mosquitto_passwd -b /mosquitto/config/passwd zhizinan admin123
docker exec mcs_mosquitto mosquitto_passwd -b /mosquitto/config/passwd worker admin123
docker exec mcs_mosquitto mosquitto_passwd -b /mosquitto/config/passwd admin admin123
```

### 4. é‡å¯æœåŠ¡

```bash
docker restart mcs_mosquitto mcs_worker
```

---

## å»ºè®®æ”¹è¿›æªæ–½

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
|:---:|--------|------|
| ğŸ”´ é«˜ | **éƒ¨ç½²è„šæœ¬è‡ªåŠ¨é…ç½® MQTT å‡­æ®** | [deploy.sh](file:///opt/mcs-iot/scripts/deploy.sh) åº”è‡ªåŠ¨å°†ç”¨æˆ·å¯†ç å†™å…¥ [mqtt_config.json](file:///opt/mcs-iot/scripts/mqtt_config.json)ï¼Œè€Œä¸æ˜¯ç•™å ä½ç¬¦ |
| ğŸ”´ é«˜ | **ç»Ÿä¸€å¯†ç é…ç½®æ¥æº** | æ‰€æœ‰ MQTT å¯†ç åº”ä» [.env](file:///opt/mcs-iot/.env) è¯»å–ï¼Œé¿å…å¤šå¤„é…ç½®ä¸ä¸€è‡´ |
| ğŸŸ¡ ä¸­ | **ACL æ¨¡æ¿åŒ…å«è®¾å¤‡ç”¨æˆ·** | éƒ¨ç½²æ—¶ ACL æ¨¡æ¿åº”æ ¹æ® [.env](file:///opt/mcs-iot/.env) è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡ç”¨æˆ·æƒé™ |
| ğŸŸ¡ ä¸­ | **å¢åŠ è¿æ¥çŠ¶æ€å¥åº·æ£€æŸ¥** | Worker å¯åŠ¨æ—¶æ£€æµ‹ MQTT è¿æ¥å¤±è´¥åº”æ›´æ˜æ˜¾åœ°æŠ¥é”™å¹¶é€€å‡º |
| ğŸŸ¢ ä½ | **æ–‡æ¡£è¡¥å……** | [CONFIG_GUIDE.md](file:///opt/mcs-iot/CONFIG_GUIDE.md) ä¸­å¢åŠ  MQTT é…ç½®æ•…éšœæ’æŸ¥ç« èŠ‚ |

---

## éªŒè¯ç»“æœ

ä¿®å¤åéªŒè¯ï¼š

```
âœ“ [H20101] å·²è¿æ¥
âœ“ [CH40102] å·²è¿æ¥
âœ“ [VOCs0103] å·²è¿æ¥
... (24ä¸ªä¼ æ„Ÿå™¨å…¨éƒ¨è¿æ¥æˆåŠŸ)

Worker æ—¥å¿—:
[INFO] processor: [H20201] v=448.7, ppm=448.50, bat=96% (Saved)
[INFO] processor: [PM250206] v=238.4, ppm=237.95, bat=89% (Saved)
```

---

## é™„å½•ï¼šå…³é”®æ–‡ä»¶è·¯å¾„

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [/opt/mcs-iot/mosquitto/config/mqtt_config.json](file:///opt/mcs-iot/mosquitto/config/mqtt_config.json) | MQTT å‡­æ®é…ç½®ï¼ˆæŒ‚è½½åˆ°å®¹å™¨ï¼‰ |
| [/opt/mcs-iot/mosquitto/config/passwd](file:///opt/mcs-iot/mosquitto/config/passwd) | Mosquitto å¯†ç æ–‡ä»¶ |
| [/opt/mcs-iot/mosquitto/config/acl](file:///opt/mcs-iot/mosquitto/config/acl) | Mosquitto ACL æƒé™é…ç½® |
| [/opt/mcs-iot/scripts/mqtt_config.json](file:///opt/mcs-iot/scripts/mqtt_config.json) | æ¨¡æ‹Ÿå™¨è„šæœ¬è¯»å–çš„é…ç½® |
| [/opt/mcs-iot/.env](file:///opt/mcs-iot/.env) | ç¯å¢ƒå˜é‡é…ç½® |
